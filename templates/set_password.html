<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restablecer Contraseña - LogiTrack</title>
    <link rel="icon" type="image/svg+xml"
        href="{{ secure_url_for(request, 'static', path='images/gear-wide-connected.svg') }}">
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100">
    <div class="max-w-md mx-auto mt-16 bg-white p-6 rounded shadow">
        <h1 class="text-xl font-semibold mb-4">Cambiar Contraseña</h1>

        {% if error %}
        <div class="bg-red-100 text-red-800 p-2 rounded mb-3">{{ error }}</div>
        {% endif %}

        {% if message %}
        <div class="bg-green-100 text-green-800 p-2 rounded mb-3">{{ message }}</div>
        {% endif %}

        <form action="{{ request.url_for('set_password_post').path }}" method="post" class="space-y-4"
            id="setPasswordForm">
            <input type="hidden" name="token" value="{{ token }}">

            <div>
                <label class="block text-sm font-medium text-gray-700">Usuario</label>
                <input type="text" name="username" value="{{ username }}" class="w-full mt-1 p-2 border rounded"
                    readonly>
            </div>

            <p class="text-sm text-gray-600">La contraseña debe tener al menos 8 caracteres e incluir letras y dígitos.
            </p>

            <div>
                <label class="block text-sm font-medium text-gray-700">Nueva contraseña</label>
                <input type="password" id="newPassword" name="new_password" required
                    class="w-full mt-1 p-2 border rounded">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Confirmar nueva contraseña</label>
                <input type="password" id="confirmPassword" name="confirm_password" required
                    class="w-full mt-1 p-2 border rounded">
            </div>

            <div id="pwFeedback" class="text-sm mt-1"></div>

            <div class="flex justify-between items-center">
                <a href="{{ secure_url_for(request, 'login') }}" class="text-sm text-blue-600 hover:underline">Volver al
                    login</a>
                <button type="submit" id="submitBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Actualizar
                    contraseña</button>
            </div>
        </form>

        <script>
            (function () {
                const newPw = document.getElementById('newPassword');
                const confirmPw = document.getElementById('confirmPassword');
                const feedback = document.getElementById('pwFeedback');
                const submitBtn = document.getElementById('submitBtn');

                function validate() {
                    const a = newPw.value || '';
                    const b = confirmPw.value || '';
                    const errors = [];
                    if (a.length < 8) errors.push('Mínimo 8 caracteres');
                    if (!/[A-Za-z]/.test(a)) errors.push('Debe incluir una letra');
                    if (!/[0-9]/.test(a)) errors.push('Debe incluir un dígito');
                    if (a && b && a !== b) errors.push('Las contraseñas no coinciden');

                    if (errors.length) {
                        feedback.textContent = errors.join(' · ');
                        feedback.className = 'text-sm text-red-600 mt-1';
                        submitBtn.disabled = true;
                        submitBtn.classList.add('opacity-60', 'cursor-not-allowed');
                    } else {
                        feedback.textContent = '';
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('opacity-60', 'cursor-not-allowed');
                    }
                }

                newPw.addEventListener('input', validate);
                confirmPw.addEventListener('input', validate);
                // Inicial validar
                validate();
            })();
        </script>
    </div>
</body>

</html>