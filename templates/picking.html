<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logix - chequeo de Picking</title>
    <link rel="icon" type="image/svg+xml"
        href="{{ secure_url_for(request, 'static', path='images/gear-wide-connected.svg') }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/css/fallback.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
        /* ===== SAP Business One Inspired Styles ===== */
        :root {
            --sap-primary: #0070d2;
            --sap-primary-dark: #005fb2;
            --sap-header-bg: #2c3e50;
            --sap-header-text: #ffffff;
            --sap-border: #d0d7de;
            --sap-hover: #f3f6f9;
            --sap-text: #32383e;
            --sap-yellow: #fbbf24;
            --sap-success: #10b981;
            --sap-error: #ef4444;
            --sap-warning: #f59e0b;
        }

        body {
            font-family: '72', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: var(--sap-text);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            margin: 0;
        }

        /* Header superior - SAP Fiori Shell Bar */
        .top-header {
            background-color: var(--sap-header-bg);
            color: white;
            padding: 0 1rem;
            height: 44px;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 0.125rem 0.5rem 0 rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        .menu-toggle {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.25rem;
            transition: background-color 0.1s ease;
        }

        .menu-toggle:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .menu-toggle:active {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .menu-toggle svg {
            width: 1.25rem;
            height: 1.25rem;
        }

        .header-title {
            font-size: 1rem;
            font-weight: 400;
            margin: 0;
            color: #fff;
        }

        /* Menú desplegable - SAP Fiori Side Navigation */
        .dropdown-menu {
            position: fixed;
            top: 44px;
            left: 0;
            width: 15rem;
            max-height: calc(100vh - 44px);
            background-color: var(--sap-header-bg);
            box-shadow: 0 0 0.5rem 0 rgba(0, 0, 0, 0.5);
            transform: translateX(-100%);
            transition: transform 0.2s cubic-bezier(0.1, 0.9, 0.2, 1);
            overflow-y: auto;
            z-index: 999;
        }

        .dropdown-menu.open {
            transform: translateX(0);
        }

        .dropdown-menu nav {
            padding: 0.5rem 0;
        }

        .dropdown-menu a,
        .dropdown-menu .logout-btn {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 1rem;
            color: #fff;
            text-decoration: none;
            border-radius: 0;
            margin: 0;
            transition: background-color 0.1s ease;
            font-size: 0.875rem;
            border-left: 0.1875rem solid transparent;
        }

        .dropdown-menu a:hover,
        .dropdown-menu .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.08);
            border-left-color: var(--sap-primary);
        }

        .dropdown-menu a:active,
        .dropdown-menu .logout-btn:active {
            background-color: rgba(255, 255, 255, 0.12);
        }

        .dropdown-menu svg {
            width: 1rem;
            height: 1rem;
            flex-shrink: 0;
        }

        .logout-btn {
            background: none;
            border: none;
            width: 100%;
            cursor: pointer;
            text-align: left;
        }

        .menu-overlay {
            position: fixed;
            top: 44px;
            left: 0;
            width: 100%;
            height: calc(100vh - 44px);
            background-color: rgba(0, 0, 0, 0.6);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
            z-index: 998;
        }

        .menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .main-content {
            flex-grow: 1;
            overflow-y: auto;
        }

        /* SAP Fiori Form Elements */
        input[type="text"],
        input[type="number"] {
            border: 1px solid var(--sap-border);
            padding: 8px 12px;
            border-radius: 3px;
            font-size: 13px;
            background-color: #ffffff;
            transition: border-color 0.2s, box-shadow 0.2s;
            font-family: inherit;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: var(--sap-primary);
            box-shadow: 0 0 0 2px rgba(0, 112, 210, 0.1);
        }

        label {
            font-weight: 600;
            margin-bottom: 4px;
            display: block;
            color: var(--sap-text);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        /* SAP Fiori Buttons */
        button {
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            font-size: 13px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: none;
            font-family: inherit;
        }

        button:hover:not(:disabled) {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .btn-primary {
            background-color: var(--sap-primary);
            color: white;
            border: 1px solid var(--sap-primary-dark);
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--sap-primary-dark);
        }

        .btn-success {
            background-color: var(--sap-success);
            color: white;
            border: 1px solid #059669;
        }

        .btn-success:hover:not(:disabled) {
            background-color: #059669;
        }

        .btn-secondary {
            background-color: #5a6c7d;
            color: white;
            border: 1px solid #4a5c6d;
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #4a5c6d;
        }

        .btn-warning {
            background-color: var(--sap-warning);
            color: white;
            border: 1px solid #d97706;
        }

        .btn-warning:hover:not(:disabled) {
            background-color: #d97706;
        }

        .btn-danger {
            background-color: var(--sap-error);
            color: white;
            border: 1px solid #dc2626;
        }

        .btn-danger:hover:not(:disabled) {
            background-color: #dc2626;
        }

        /* SAP Fiori Section Headers */
        .section-header {
            background: linear-gradient(135deg, var(--sap-header-bg) 0%, #34495e 100%);
            color: white;
            padding: 12px 16px;
            margin: -24px -24px 16px -24px;
            border-radius: 4px 4px 0 0;
        }

        .section-header h1,
        .section-header h2 {
            margin: 0;
            letter-spacing: 0.3px;
            font-weight: 600;
        }

        /* SAP Fiori Cards */
        .sap-card {
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--sap-border);
            padding: 24px;
        }

        /* SAP Fiori Tables */
        table {
            border-collapse: separate;
            border-spacing: 0;
        }

        thead th {
            background-color: #f8f9fa;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
            color: #6c757d;
            border-bottom: 2px solid var(--sap-border);
        }

        tbody tr {
            transition: background-color 0.15s ease;
        }

        tbody tr:hover {
            background-color: var(--sap-hover);
        }

        tbody td {
            border-bottom: 1px solid #e9ecef;
        }

        /* Inputs dentro de tablas - más visibles */
        table input[type="number"] {
            border: 1.5px solid var(--sap-border);
            background-color: #ffffff;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        table input[type="number"]:focus {
            border-color: var(--sap-primary);
            box-shadow: 0 0 0 2px rgba(0, 112, 210, 0.15), inset 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        /* Ocultar el 'spinner' de los inputs numéricos */
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type='number'] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        /* Estilo para el lector de QR */
        #qr-reader {
            border: 2px dashed var(--sap-border);
            border-radius: 4px;
            overflow: hidden;
            background-color: #f7fafc;
        }

        /* SAP Fiori Messages/Toasts */
        #message-box {
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* SAP Fiori Modals */
        .modal-content {
            border-radius: 4px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>


<body>
    <!-- Overlay que pide girar el dispositivo a modo vertical -->
    <div id="rotate-overlay"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 text-white p-4">
        <div class="max-w-sm text-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto mb-4" width="64" height="64" viewBox="0 0 24 24"
                fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M12 2v4M12 18v4M4 12H2M22 12h-2M5 5l-1.5-1.5M20 20l1.5 1.5M19 5l1.5-1.5M4 20L2.5 21.5"
                    stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <h2 class="text-xl font-semibold">Gira el dispositivo</h2>
            <p class="mt-2 text-sm">Para una mejor experiencia, usa esta pantalla en modo vertical (portrait).</p>
        </div>
    </div>

    <!-- Header superior con menú -->
    <header class="top-header">
        <button class="menu-toggle" id="menuToggle" aria-label="Abrir menú">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
            </svg>
        </button>
        <h1 class="header-title">Logix - Chequeo de Picking</h1>
    </header>

    <!-- Menú desplegable -->
    {% include '_menu.html' %}

    <!-- Overlay para cerrar el menú -->
    <div class="menu-overlay" id="menuOverlay"></div>

    <!-- Contenido principal -->
    <main class="main-content">
        <div class="container mx-auto max-w-4xl w-full px-2 pb-2 pt-4 md:px-4 md:pb-4">
            <div class="bg-white p-6 md:p-8 rounded-lg shadow-xl border border-gray-200">

                <!-- Sección 1: Carga de Pedido -->
                <section id="load-section" class="mb-6">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Chequeo de Picking</h1>
                    <h2 class="text-xl font-semibold mb-4">1. Cargar Pedido</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="order-number" class="block text-sm font-medium text-gray-700">Order
                                Number</label>
                            <input type="text" id="order-number" inputmode="numeric"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-base sm:text-sm"
                                placeholder="Ej: 0043785">
                        </div>
                        <div>
                            <label for="despatch-number" class="block text-sm font-medium text-gray-700">Despatch
                                Number</label>
                            <input type="text" id="despatch-number" inputmode="numeric"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-base sm:text-sm"
                                placeholder="Ej: 00">
                        </div>
                    </div>

                    <button id="load-order-btn"
                        class="mt-6 w-full bg-blue-600 text-white py-2 px-4 rounded-md font-semibold shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Cargar Pedido
                    </button>

                    <!-- Tabla de Seguimiento de Pedidos -->
                    <div class="mt-8">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Seguimiento de Pedidos</h3>
                            <button id="refresh-tracking-btn"
                                class="bg-gray-600 text-white py-1 px-3 rounded-md font-semibold shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 text-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="inline-block w-4 h-4 mr-1" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                                Actualizar
                            </button>
                        </div>
                        <div class="border rounded-md overflow-hidden">
                            <div class="max-h-[300px] overflow-y-auto">
                                <table class="w-full divide-y divide-gray-200 table-auto">
                                    <thead class="bg-gray-50 sticky top-0 z-10">
                                        <tr>
                                            <th scope="col"
                                                class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider w-20 cursor-pointer hover:bg-gray-100"
                                                onclick="sortTable('order_number')">
                                                Order Number <span id="sort-icon-order_number"></span>
                                            </th>
                                            <th scope="col"
                                                class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider w-20 cursor-pointer hover:bg-gray-100"
                                                onclick="sortTable('despatch_number')">
                                                Despatch Number <span id="sort-icon-despatch_number"></span>
                                            </th>
                                            <th scope="col"
                                                class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                                                onclick="sortTable('customer_name')">
                                                Cliente <span id="sort-icon-customer_name"></span>
                                            </th>
                                            <th scope="col"
                                                class="px-3 py-2 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider w-15 cursor-pointer hover:bg-gray-100"
                                                onclick="sortTable('total_lines')">
                                                Líneas <span id="sort-icon-total_lines"></span>
                                            </th>
                                            <th scope="col"
                                                class="px-3 py-2 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                                                onclick="sortTable('print_date')">
                                                Fecha Impresión <span id="sort-icon-print_date"></span>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="tracking-table-body" class="bg-white divide-y divide-gray-200">
                                        <!-- Las filas se insertarán aquí dinámicamente -->
                                        <tr>
                                            <td colspan="5" class="px-3 py-4 text-center text-sm text-gray-500">
                                                Cargando datos...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </section>

                <!-- Sección 2: Chequeo (Oculta por defecto) -->
                <section id="audit-section" class="hidden">
                    <header class="mb-6">
                        <h1 class="text-3xl font-bold text-gray-800">Chequeo de picking</h1>
                    </header>

                    <div class="mb-6 space-y-2">
                        <p class="text-lg">Orden: <span id="order-number-display"
                                class="font-bold text-gray-700"></span>/<span id="despatch-number-display"
                                class="font-bold text-gray-700"></span></p>
                        <p class="text-lg">Cliente: <span id="customer-name" class="font-bold text-gray-700"></span></p>
                    </div>

                    <!-- Escáner y Búsqueda de Items (Diseño de la imagen) -->
                    <div class="mb-6">
                        <label for="itemCode" class="block text-sm font-medium text-gray-700 mb-1">ITEM CODE:</label>
                        <div class="flex items-center gap-2">
                            <input type="text" id="itemCode" name="itemCode"
                                class="flex-grow block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-base sm:text-sm"
                                placeholder="Escanee el código o ingrese el item"
                                oninput="this.value = this.value.toUpperCase()" />

                            <!-- Botón QR -->
                            <button type="button" id="scanItemBtn" title="Escanear código de barras"
                                class="flex-shrink-0 p-2 border border-gray-300 bg-gray-100 text-gray-600 rounded-md shadow-sm hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"
                                    class="bi bi-qr-code-scan" viewBox="0 0 16 16">
                                    <path
                                        d="M0 .5A.5.5 0 0 1 .5 0h3a.5.5 0 0 1 0 1H1v2.5a.5.5 0 0 1-1 0zm12 0a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0V1h-2.5a.5.5 0 0 1-.5-.5M.5 12a.5.5 0 0 1 .5.5V15h2.5a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5v-3a.5.5 0 0 1 .5-.5m15 0a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1 0-1H15v-2.5a.5.5 0 0 1 .5-.5M4 4h1v1H4z" />
                                    <path d="M7 2H2v5h5zM3 3h3v3H3zm2 8H4v1h1z" />
                                    <path d="M7 9H2v5h5zm-4 1h3v3H3zm8-6h1v1h-1z" />
                                    <path
                                        d="M9 2h5v5H9zm1 1v3h3V3zM8 8v2h1v1H8v1h2v-2h1v2h1v-1h2v-1h-3V8zm2 2H9V9h1zm4 2h-1v1h-2v1h3zm-4 2v-1H8v1z" />
                                    <path d="M12 9h2V8h-2z" />
                                </svg>
                            </button>
                            <!-- Botón Buscar -->
                            <button type="button" id="findItemBtn"
                                class="flex-shrink-0 bg-gray-600 text-white py-2 px-5 rounded-md font-semibold shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                Buscar
                            </button>
                        </div>
                    </div>



                    <!-- Lista de Items -->
                    <div>
                        <h3 class="text-xl font-semibold mb-4">Lista de items</h3>
                        <div class="border rounded-md max-h-[400px] md:max-h-[500px] overflow-y-auto">
                            <table class="w-full divide-y divide-gray-200 table-auto">
                                <!-- ***** CORRECCIÓN APLICADA AQUÍ (thead) ***** -->
                                <thead class="bg-gray-50 sticky top-0 z-10">
                                    <tr>
                                        <th scope="col"
                                            class="px-0.5 py-1 text-center text-xs font-small text-gray-500 uppercase tracking-wider w-12">
                                            Línea</th>
                                        <th scope="col"
                                            class="px-0.5 py-1 text-left text-xs font-small text-gray-500 uppercase tracking-wider w-28">
                                            Item</th>
                                        <th scope="col"
                                            class="px-0.5 py-1 text-left text-xs font-small text-gray-500 uppercase tracking-wider w-45">
                                            Descripción</th>
                                        <th scope="col"
                                            class="px-0.5 py-1 text-center text-xs font-small text-gray-500 uppercase tracking-wider w-12">
                                            Req.</th>
                                        <th scope="col"
                                            class="px-0.5 py-1 text-center text-xs font-small text-gray-500 uppercase tracking-wider w-14">
                                            Scan.</th>
                                        <th scope="col"
                                            class="px-0.5 py-1 text-center text-xs font-small text-gray-500 uppercase tracking-wider w-12">
                                            Dif.</th>
                                    </tr>
                                </thead>
                                <tbody id="items-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Filas de items se insertarán aquí -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Acciones Finales (Diseño de la imagen) -->
                    <div class="mt-4 flex flex-col md:flex-row gap-4">
                        <button id="finalize-btn"
                            class="flex-1 order-1 bg-green-600 text-white py-3 px-6 rounded-md font-semibold shadow-sm hover:bg-green-700 text-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            Finalizar Auditoría
                        </button>
                        <button id="reset-btn"
                            class="flex-1 order-2 md:order-2 bg-gray-200 text-gray-700 py-3 px-6 rounded-md font-semibold hover:bg-gray-300 text-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                            Cargar Otro Pedido
                        </button>
                    </div>
                </section>
            </div>
        </div>

        <!-- Modal del Escáner -->
        <div id="scanner-modal"
            class="hidden fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-[95%] max-w-lg p-6">
                <h3 class="text-lg font-bold mb-4 text-center">Apunta la cámara al código de barras</h3>
                <div id="qr-reader" class="w-full rounded-md overflow-hidden border"></div>
                <button id="close-scanner-btn"
                    class="mt-4 w-full bg-red-600 text-white py-2 rounded-md hover:bg-red-700">Cancelar</button>
            </div>
        </div>

        <!-- Contenedor de Mensajes (Toast) -->
        <div id="message-box"
            class="fixed top-5 right-5 left-5 md:left-auto md:w-auto z-50 p-4 rounded-md text-white font-semibold shadow-lg transition-all duration-300 opacity-0 translate-x-10 hidden text-center md:text-left">
            <span id="message-text"></span>
        </div>

        <!-- Modal de Confirmación -->
        <div id="confirmation-modal"
            class="hidden fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6">
                <h3 class="text-xl font-bold text-yellow-600 mb-4">Confirmar Finalización</h3>
                <p class="text-gray-700 mb-6">Se detectaron diferencias en el picking (faltantes o sobrantes). ¿Desea
                    guardar y finalizar la auditoría de todos modos?</p>
                <div class="flex justify-end gap-4">
                    <button id="cancel-modal-btn"
                        class="py-2 px-4 bg-gray-200 text-gray-700 rounded-md font-semibold hover:bg-gray-300">Cancelar</button>
                    <button id="confirm-modal-btn"
                        class="py-2 px-4 bg-yellow-500 text-white rounded-md font-semibold hover:bg-yellow-600">Confirmar
                        y
                        Guardar</button>
                </div>
            </div>
        </div>

        <!-- Modal de Cantidad -->
        <div id="quantity-modal"
            class="hidden fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4" id="quantity-modal-item-name"></h3>
                <p class="text-gray-700 mb-4">Ingrese la cantidad alistada:</p>
                <input type="number" id="quantity-input" inputmode="numeric" aria-label="Cantidad alistada"
                    placeholder="0"
                    class="w-full text-center border border-gray-300 rounded-md shadow-sm py-2 text-2xl" />
                <div class="flex justify-end gap-4 mt-6">
                    <button id="cancel-quantity-btn"
                        class="py-2 px-4 bg-gray-200 text-gray-700 rounded-md font-semibold hover:bg-gray-300">Cancelar</button>
                    <button id="confirm-quantity-btn"
                        class="py-2 px-4 bg-blue-600 text-white rounded-md font-semibold hover:bg-blue-700">Confirmar</button>
                </div>
            </div>
        </div>

        <!-- Modal de Cantidad de Bultos/Paquetes -->
        <div id="packages-modal"
            class="hidden fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Cantidad de Bultos</h3>
                <p class="text-gray-700 mb-4">Ingrese la cantidad total de bultos o paquetes del pedido:</p>
                <input type="number" id="packages-input" inputmode="numeric" aria-label="Cantidad de bultos"
                    placeholder="0" min="1"
                    class="w-full text-center border border-gray-300 rounded-md shadow-sm py-2 text-2xl" />
                <div class="flex justify-end gap-4 mt-6">
                    <button id="cancel-packages-btn"
                        class="py-2 px-4 bg-gray-200 text-gray-700 rounded-md font-semibold hover:bg-gray-300">Cancelar</button>
                    <button id="confirm-packages-btn"
                        class="py-2 px-4 btn-success text-white rounded-md font-semibold">Confirmar</button>
                </div>
            </div>
        </div>


        <script>
            // --- Variables Globales ---
            let orderItems = []; // Almacenará los items del pedido filtrado
            let currentTrackingData = []; // Datos de seguimiento actuales
            let sortDirection = {}; // Estado de ordenamiento por columna (true=asc, false=desc)
            let customerName = "";
            let html5QrCode;
            let soundBeep, soundBoop;
            let currentItemForQuantity = null;
            let packagesQuantity = 0; // Cantidad de bultos/paquetes
            let editMode = false; // Modo edición
            let editAuditId = null; // ID de auditoría en edición
            let originalItemValues = {}; // Valores originales para detectar cambios

            // --- Selectores del DOM ---
            const loadSection = document.getElementById('load-section');
            const auditSection = document.getElementById('audit-section');
            const loadOrderBtn = document.getElementById('load-order-btn');
            const orderNumberInput = document.getElementById('order-number');
            const despatchNumberInput = document.getElementById('despatch-number');
            const customerNameEl = document.getElementById('customer-name');
            const orderNumberDisplay = document.getElementById('order-number-display');
            const despatchNumberDisplay = document.getElementById('despatch-number-display');
            const itemsTableBody = document.getElementById('items-table-body');
            const itemCodeInput = document.getElementById('itemCode');
            const scanItemBtn = document.getElementById('scanItemBtn');
            const findItemBtn = document.getElementById('findItemBtn');
            const finalizeBtn = document.getElementById('finalize-btn');
            const resetBtn = document.getElementById('reset-btn');
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            const confirmationModal = document.getElementById('confirmation-modal');
            const cancelModalBtn = document.getElementById('cancel-modal-btn');
            const confirmModalBtn = document.getElementById('confirm-modal-btn');
            const quantityModal = document.getElementById('quantity-modal');
            const quantityModalItemName = document.getElementById('quantity-modal-item-name');
            const quantityInput = document.getElementById('quantity-input');
            const cancelQuantityBtn = document.getElementById('cancel-quantity-btn');
            const confirmQuantityBtn = document.getElementById('confirm-quantity-btn');
            const scannerModal = document.getElementById('scanner-modal');
            const closeScannerBtn = document.getElementById('close-scanner-btn');
            const packagesModal = document.getElementById('packages-modal');
            const packagesInput = document.getElementById('packages-input');
            const cancelPackagesBtn = document.getElementById('cancel-packages-btn');
            const confirmPackagesBtn = document.getElementById('confirm-packages-btn');

            // --- Inicialización ---
            document.addEventListener('DOMContentLoaded', () => {
                // Inicializar el objeto del escáner
                try {
                    html5QrCode = new Html5Qrcode("qr-reader");
                    const Html5QrcodeScanType = {
                        SCAN_TYPE_CAMERA: 0,
                        SCAN_TYPE_FILE: 1
                    }
                } catch (e) {
                    console.error("No se pudo inicializar Html5Qrcode. Asegúrese de que el div 'qr-reader' existe.", e);
                    showMessage("Error al iniciar el componente de escáner.", "error");
                }

                // Inicializar sonidos con HTML5 Audio (compatible con móviles)
                // Crear sonidos usando data URIs con frecuencias generadas
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                let audioInitialized = false;

                // Función para crear un beep con Web Audio API
                function createBeep(frequency, duration) {
                    if (!audioInitialized) {
                        // Inicializar el contexto de audio con la primera interacción
                        audioContext.resume();
                        audioInitialized = true;
                    }
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.value = frequency;
                    oscillator.type = frequency > 600 ? 'sine' : 'square';

                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);

                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + duration);
                }

                // Objetos de sonido compatibles con la interfaz anterior
                soundBeep = {
                    triggerAttackRelease: () => createBeep(800, 0.1) // Sonido agudo
                };
                soundBoop = {
                    triggerAttackRelease: () => createBeep(200, 0.2) // Sonido grave
                };

                // Cargar datos de seguimiento al iniciar
                loadTrackingData();
            });

            // --- Funciones para Tabla de Seguimiento ---

            /**
             * Carga los datos de seguimiento desde la API.
             */
            async function loadTrackingData() {
                const trackingTableBody = document.getElementById('tracking-table-body');
                const refreshBtn = document.getElementById('refresh-tracking-btn');

                try {
                    const response = await fetch('/api/picking/tracking');

                    if (!response.ok) {
                        throw new Error('Error al cargar datos de seguimiento');
                    }

                    const trackingData = await response.json();
                    currentTrackingData = trackingData; // Guardar globalmente

                    // Ordenar por fecha de impresión descendente por defecto si no hay orden previo
                    if (Object.keys(sortDirection).length === 0) {
                        sortDirection['print_date'] = false; // Descendente inicial
                        sortTableData('print_date', false);
                    } else {
                        renderTrackingTable(); // Renderizar con el orden actual si ya existe
                    }

                } catch (error) {
                    console.error('Error loading tracking data:', error);
                    trackingTableBody.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-3 py-4 text-center text-sm text-red-500">
                                Error al cargar datos de seguimiento
                            </td>
                        </tr>
                    `;
                }
            }

            // Función para manejar el click en los encabezados
            function sortTable(column) {
                // Alternar dirección: si no existe o es false (desc), pasa a true (asc). Si es true (asc), pasa a false (desc).
                // Nota: Inicialmente quiero que el primer click sea descendente si no hay nada, pero arriba puse defecto.
                // Lógica estándar: click -> toggle.

                // Si ya estaba ordenando por esta columna, invertir. Si no, default a ascendente (true) o descendente según prefieras.
                // Comportamiento común: primer click -> ascendente.

                if (sortDirection[column] === undefined) {
                    sortDirection[column] = true; // Primer click: Ascendente
                } else {
                    sortDirection[column] = !sortDirection[column]; // Invertir
                }

                // Limpiar iconos de otras columnas (opcional, o mantener estado múltiple, pero simple es mejor solo uno)
                // Para single-column sort:
                Object.keys(sortDirection).forEach(key => {
                    if (key !== column) delete sortDirection[key];
                });

                sortTableData(column, sortDirection[column]);
            }

            function sortTableData(column, asc) {
                if (!currentTrackingData || currentTrackingData.length === 0) return;

                currentTrackingData.sort((a, b) => {
                    let valA = a[column];
                    let valB = b[column];

                    // Manejo de nulos
                    if (valA == null) valA = "";
                    if (valB == null) valB = "";

                    // Conversión numérica si aplica
                    if (column === 'total_lines') {
                        valA = Number(valA);
                        valB = Number(valB);
                    }

                    if (valA < valB) return asc ? -1 : 1;
                    if (valA > valB) return asc ? 1 : -1;
                    return 0;
                });

                updateSortIcons(column, asc);
                renderTrackingTable();
            }

            function updateSortIcons(activeColumn, asc) {
                // Limpiar todos los iconos
                const cols = ['order_number', 'despatch_number', 'customer_name', 'total_lines', 'print_date'];
                cols.forEach(col => {
                    const iconEl = document.getElementById(`sort-icon-${col}`);
                    if (iconEl) iconEl.textContent = ''; // Limpiar
                });

                // Poner flecha en la columna activa
                const activeIcon = document.getElementById(`sort-icon-${activeColumn}`);
                if (activeIcon) {
                    activeIcon.textContent = asc ? ' ▲' : ' ▼'; // Flecha arriba o abajo
                }
            }

            function renderTrackingTable() {
                const trackingTableBody = document.getElementById('tracking-table-body');
                trackingTableBody.innerHTML = '';

                if (currentTrackingData.length === 0) {
                    trackingTableBody.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-3 py-4 text-center text-sm text-gray-500">
                                No hay pedidos disponibles
                            </td>
                        </tr>
                    `;
                    return;
                }

                currentTrackingData.forEach(order => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 transition-colors duration-150';
                    row.innerHTML = `
                        <td class="px-3 py-2 text-sm font-medium text-gray-900">${order.order_number}</td>
                        <td class="px-3 py-2 text-sm text-gray-700">${order.despatch_number}</td>
                        <td class="px-3 py-2 text-sm text-gray-700 whitespace-nowrap">${order.customer_name}</td>
                        <td class="px-3 py-2 text-sm text-center font-semibold text-blue-600">${order.total_lines}</td>
                        <td class="px-3 py-2 text-sm text-center text-gray-600 whitespace-nowrap">${order.print_date}</td>
                    `;
                    trackingTableBody.appendChild(row);
                });
            }

            // Event listener para el botón de actualizar
            document.getElementById('refresh-tracking-btn').addEventListener('click', () => {
                loadTrackingData();
                showMessage('Datos de seguimiento actualizados', 'success');

            });

            // --- Event Listeners ---
            loadOrderBtn.addEventListener('click', loadOrder); // Cambiado a la función original
            orderNumberInput.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); loadOrder(); } });
            despatchNumberInput.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); loadOrder(); } });
            scanItemBtn.addEventListener('click', startScanner);
            closeScannerBtn.addEventListener('click', stopScanner);
            findItemBtn.addEventListener('click', () => processScan(itemCodeInput.value));
            itemCodeInput.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); processScan(itemCodeInput.value); } });
            finalizeBtn.addEventListener('click', finalizeAudit);
            resetBtn.addEventListener('click', resetApp);
            cancelModalBtn.addEventListener('click', () => confirmationModal.classList.add('hidden'));
            confirmModalBtn.addEventListener('click', confirmFinalizeWithDifferences);
            cancelQuantityBtn.addEventListener('click', hideQuantityModal);
            confirmQuantityBtn.addEventListener('click', confirmQuantity);
            cancelPackagesBtn.addEventListener('click', hidePackagesModal);
            confirmPackagesBtn.addEventListener('click', confirmPackages);
            packagesInput.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); confirmPackages(); } });
            quantityInput.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); confirmQuantity(); } });

            // --- Detectar modo edición al cargar la página ---
            const urlParams = new URLSearchParams(window.location.search);
            const editId = urlParams.get('edit');
            if (editId) {
                editMode = true;
                editAuditId = parseInt(editId);
                loadAuditForEdit(editAuditId);
            }

            // --- Funciones Principales ---

            /**
             * Carga una auditoría existente para edición.
             */
            async function loadAuditForEdit(auditId) {
                try {
                    const response = await fetch(`/api/picking_audit/${auditId}`);
                    if (!response.ok) {
                        const error = await response.json();
                        showMessage(error.detail || 'Error al cargar la auditoría', 'error');
                        return;
                    }

                    const audit = await response.json();

                    // Pre-llenar datos del pedido
                    orderNumberInput.value = audit.order_number;
                    despatchNumberInput.value = audit.despatch_number;
                    customerName = audit.customer_name;
                    packagesQuantity = audit.packages;

                    // Cargar items
                    orderItems = audit.items.map(item => ({
                        order_line: item.order_line || '',
                        code: item.code,
                        description: item.description,
                        qty_req: item.qty_req,
                        qty_scan: item.qty_scan
                    }));

                    // Guardar valores originales
                    orderItems.forEach(item => {
                        originalItemValues[item.code] = item.qty_scan;
                    });

                    // Mostrar sección de auditoría
                    loadSection.classList.add('hidden');
                    auditSection.classList.remove('hidden');
                    customerNameEl.textContent = customerName;
                    orderNumberDisplay.textContent = audit.order_number;
                    despatchNumberDisplay.textContent = audit.despatch_number;

                    // Cambiar texto del botón
                    finalizeBtn.textContent = 'Actualizar Auditoría';

                    updateTable();
                    showMessage('Auditoría cargada para edición', 'success');
                } catch (error) {
                    console.error('Error loading audit:', error);
                    showMessage('Error al cargar la auditoría', 'error');
                }
            }

            /**
             * Carga el pedido desde la API (función original).
             */
            async function loadOrder() {
                const orderNum = orderNumberInput.value.trim();
                const despatchNum = despatchNumberInput.value.trim();

                if (!orderNum || !despatchNum) {
                    showMessage("Por favor, ingrese 'Order Number' y 'Despatch Number'.", "error");
                    return;
                }

                try {
                    // Esta es la llamada a la API que tu código original tenía
                    const response = await fetch(`/api/picking/order/${orderNum}/${despatchNum}`);

                    if (!response.ok) {
                        let errorMsg = `Error al cargar el pedido. Código: ${response.status}`;
                        try {
                            const errorData = await response.json();
                            errorMsg = errorData.detail || errorMsg;
                        } catch (e) {
                            // No se pudo parsear el JSON de error, usar mensaje genérico
                        }
                        throw new Error(errorMsg);
                    }

                    const filteredItems = await response.json();

                    if (filteredItems.length === 0) {
                        showMessage("Pedido no encontrado. Verifique los números.", "error");
                        return;
                    }

                    // Procesar los items encontrados
                    orderItems = filteredItems.map(item => ({
                        order_line: item["Order Line"] ? item["Order Line"].trim() : '',
                        code: item["Item Code"] ? item["Item Code"].trim() : '',
                        description: item["Item Description"] ? item["Item Description"].trim() : 'Sin descripción',
                        qty_req: parseInt(item["Qty"], 10) || 0,
                        qty_scan: 0
                    }));

                    customerName = filteredItems[0]["Customer Name"] || "N/A";

                    // Actualizar la UI
                    customerNameEl.textContent = customerName;
                    orderNumberDisplay.textContent = orderNum;
                    despatchNumberDisplay.textContent = despatchNum;
                    updateTable();
                    loadSection.classList.add('hidden');
                    auditSection.classList.remove('hidden');
                    showMessage(`Pedido ${orderNum}/${despatchNum} cargado. Listo para escanear.`, "success");
                    itemCodeInput.focus(); // Poner foco en el input de item

                } catch (e) {
                    showMessage(e.message, "error");
                    console.error(e);
                }
            }


            /**
             * Actualiza la tabla de items con los datos actuales de 'orderItems'.
             */
            function updateTable() {
                itemsTableBody.innerHTML = '';
                let allComplete = true;

                if (orderItems.length === 0) return;

                orderItems.forEach((item, index) => {
                    const diff = item.qty_scan - item.qty_req;
                    let rowClass = 'bg-white';
                    let diffClass = 'text-gray-700';

                    if (diff === 0 && item.qty_scan > 0 && item.qty_scan === item.qty_req) {
                        rowClass = 'bg-green-50'; // Completo
                        diffClass = 'text-green-700 font-bold';
                    } else if (diff < 0 && item.qty_scan > 0) {
                        rowClass = 'bg-yellow-50'; // Parcial
                        diffClass = 'text-yellow-700 font-bold';
                    } else if (diff > 0) {
                        rowClass = 'bg-red-50'; // Sobrante
                        diffClass = 'text-red-700 font-bold';
                    } else if (diff < 0) {
                        diffClass = 'text-red-700 font-bold'; // Faltante (aún no escaneado)
                    }

                    if (diff !== 0) {
                        allComplete = false;
                    }

                    const row = document.createElement('tr');
                    row.className = `${rowClass} transition-colors duration-200`;

                    // Detectar si el item fue editado (comparar con valor original)
                    const isEdited = editMode && originalItemValues[item.code] !== undefined && originalItemValues[item.code] !== item.qty_scan;
                    const editedClass = isEdited ? 'border-2 border-orange-500' : 'border border-gray-300';

                    // ***** CORRECCIÓN APLICADA AQUÍ (tbody) *****
                    row.innerHTML = `
                        <td class="px-0.5 py-1 text-xs md:text-sm text-gray-700 text-center">${item.order_line || ''}</td>
                        <td class="px-1 py-1 text-xs md:text-sm font-medium text-gray-900 max-w-[120px] truncate" title="${item.code}">${item.code}${isEdited ? ' <span class="text-orange-600 text-xs">✎</span>' : ''}</td>
                        <td class="px-1 py-1 text-xs md:text-sm text-gray-600 max-w-[150px] truncate" title="${item.description}">${item.description}</td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs md:text-sm font-bold text-blue-700 text-center">${item.qty_req}</td>
                        <td class="px-0.5 py-1 whitespace-nowrap text-xs md:text-sm font-bold text-center">
                            <input type="number" value="${item.qty_scan > 0 ? item.qty_scan : ''}" min="0" class="w-10 text-center text-base md:text-sm ${editedClass} rounded-md shadow-sm py-1" data-index="${index}" data-item-code="${item.code}">
                        </td>
                        <td class="px-1 py-1 whitespace-nowrap text-xs md:text-sm font-semibold ${diffClass} text-center">${diff}</td>
                    `;
                    itemsTableBody.appendChild(row);
                });

                // Añadir event listeners a los inputs numéricos de la tabla
                itemsTableBody.querySelectorAll('input[type="number"]').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const index = e.target.dataset.index;
                        const itemCode = e.target.dataset.itemCode;
                        let newQty = parseInt(e.target.value, 10);

                        if (isNaN(newQty) || newQty < 0) {
                            newQty = 0; // Resetear a 0 si es inválido
                        }

                        orderItems[index].qty_scan = newQty;

                        // Actualizar clase visual si está en modo edición
                        if (editMode && originalItemValues[itemCode] !== undefined) {
                            if (originalItemValues[itemCode] !== newQty) {
                                e.target.classList.remove('border-gray-300');
                                e.target.classList.add('border-2', 'border-orange-500');
                            } else {
                                e.target.classList.remove('border-2', 'border-orange-500');
                                e.target.classList.add('border', 'border-gray-300');
                            }
                        }

                        updateTable(); // Re-dibujar la tabla para reflejar el cambio
                    });
                });

                // Si todo está completo, mostrar mensaje
                if (allComplete && orderItems.length > 0) {
                    showMessage("¡Picking Completo! Todos los items verificados.", "success");
                }
            }

            /**
             * Inicia la cámara para escanear.
             */
            function startScanner() {
                scannerModal.classList.remove('hidden');
                if (!html5QrCode) {
                    html5QrCode = new Html5Qrcode("qr-reader");
                }

                const config = {
                    fps: 10,
                    qrbox: (viewfinderWidth, viewfinderHeight) => {
                        const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
                        const qrboxSize = Math.floor(minEdge * 0.8); // 80% del borde más pequeño
                        return { width: qrboxSize, height: qrboxSize };
                    },
                    rememberLastUsedCamera: true,
                    supportedScanTypes: [
                        Html5QrcodeScanType.SCAN_TYPE_CAMERA
                    ]
                };

                html5QrCode.start(
                    { facingMode: "environment" }, // Pedir cámara trasera
                    config,
                    (decodedText, decodedResult) => {
                        stopScanner();
                        processScan(decodedText);
                    }, // onScanSuccess
                    (error) => { /* onScanFailure (opcional) */ }
                ).then(() => {
                    showMessage("Cámara iniciada. Apunte al código.", "info");
                }).catch(err => {
                    showMessage("Error al iniciar la cámara. Verifique permisos.", "error");
                    console.error(err);
                    stopScanner();
                });
            }

            /**
             * Detiene el escáner de la cámara.
             */
            function stopScanner() {
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop()
                        .then(() => {
                            showMessage("Escáner detenido.", "info");
                        })
                        .catch(err => {
                            console.error("Error al detener el escáner:", err);
                        });
                }
                scannerModal.classList.add('hidden');
            }

            /**
             * Procesa un código escaneado (de cámara o manual).
             */
            function processScan(scannedCode) {
                if (!scannedCode || scannedCode.trim() === '') return;

                scannedCode = scannedCode.trim().toUpperCase(); // Asegurarse de que esté en mayúsculas
                const item = orderItems.find(i => i.code === scannedCode);

                if (item) {
                    showQuantityModal(item);
                    soundBeep.triggerAttackRelease("C5", "0.1"); // Sonido agudo OK
                } else {
                    soundBoop.triggerAttackRelease("C3", "0.2"); // Sonido grave ERROR
                    showMessage(`ERROR: Item incorrecto (${scannedCode})`, "error");
                    itemCodeInput.value = ''; // Limpiar input manual
                    itemCodeInput.focus(); // Devolver el foco al input
                }
            }

            function showQuantityModal(item) {
                currentItemForQuantity = item;
                quantityModalItemName.textContent = `${item.code} - ${item.description}`;
                quantityInput.value = ''; // Clear previous value
                quantityModal.classList.remove('hidden');
                quantityInput.focus();
            }

            function hideQuantityModal() {
                quantityModal.classList.add('hidden');
                currentItemForQuantity = null;
                itemCodeInput.value = ''; // Limpiar input manual
                itemCodeInput.focus(); // Devolver el foco al input
            }

            function confirmQuantity() {
                if (!currentItemForQuantity) return;

                const quantity = parseInt(quantityInput.value, 10);
                if (!isNaN(quantity) && quantity >= 0) {
                    const previousQty = currentItemForQuantity.qty_scan;
                    const required = currentItemForQuantity.qty_req;
                    const newTotal = previousQty + quantity;

                    // VALIDAR: Si la nueva cantidad excede lo requerido, NO permitir
                    if (newTotal > required) {
                        soundBoop.triggerAttackRelease(); // Pitido de error
                        const excess = newTotal - required;
                        showMessage(`❌ ERROR: La cantidad ingresada (${quantity}) excede lo requerido. Ya tienes ${previousQty}/${required}. Sobrante: ${excess}`, "error");
                        quantityInput.value = ''; // Limpiar el input
                        quantityInput.focus(); // Mantener el foco en el modal
                        return; // NO cerrar el modal, NO registrar
                    }

                    // SUMAR la cantidad ingresada a la cantidad ya escaneada
                    currentItemForQuantity.qty_scan = newTotal;

                    showMessage(`OK: ${currentItemForQuantity.description} - Cantidad: ${quantity} (Total: ${newTotal}/${required})`, "success");
                    updateTable();

                    // Highlight row
                    const row = itemsTableBody.querySelector(`input[data-index="${orderItems.indexOf(currentItemForQuantity)}"]`);
                    if (row) {
                        row.closest('tr').classList.add('bg-blue-100');
                        setTimeout(() => {
                            const currentRow = itemsTableBody.querySelector(`input[data-index="${orderItems.indexOf(currentItemForQuantity)}"]`);
                            if (currentRow) {
                                currentRow.closest('tr').classList.remove('bg-blue-100');
                            }
                        }, 1500);
                    }

                    // Verificar si el item está completo
                    if (newTotal === required) {
                        soundBeep.triggerAttackRelease(); // Pitido de éxito
                        setTimeout(() => {
                            showMessage(`✅ COMPLETO: ${currentItemForQuantity.code} - Cantidad alistada: ${newTotal}/${required}`, "success");
                        }, 200);
                    }
                } else {
                    showMessage('Por favor ingrese una cantidad válida.', 'error');
                }
                hideQuantityModal();
            }

            async function saveAuditData(status) {
                const auditData = {
                    order_number: orderNumberDisplay.textContent,
                    despatch_number: despatchNumberDisplay.textContent,
                    customer_name: customerName,
                    status: status,
                    items: orderItems,
                    packages: packagesQuantity
                };

                try {
                    let url, method;
                    if (editMode && editAuditId) {
                        // Modo edición: usar PUT
                        url = `/api/update_picking_audit/${editAuditId}`;
                        method = 'PUT';
                    } else {
                        // Modo nuevo: usar POST
                        url = '/api/save_picking_audit';
                        method = 'POST';
                    }

                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(auditData),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Error al guardar la auditoría.');
                    }

                    const result = await response.json();
                    console.log(editMode ? 'Auditoría actualizada:' : 'Auditoría guardada:', result);
                    return true;

                } catch (error) {
                    console.error('Error al guardar la auditoría:', error);
                    showMessage(error.message, 'error');
                    return false;
                }
            }

            /**
             * Finaliza la auditoría. Comprueba diferencias y solicita cantidad de bultos.
             */
            async function finalizeAudit() {
                // Asegurarse de que se haya cargado un pedido
                if (orderItems.length === 0) {
                    showMessage("No hay ningún pedido cargado para finalizar.", "error");
                    return;
                }

                const differencesExist = orderItems.some(item => item.qty_scan !== item.qty_req);

                if (differencesExist) {
                    // Hay diferencias, mostrar modal de confirmación
                    confirmationModal.classList.remove('hidden');
                } else {
                    // Todo OK, mostrar modal de bultos
                    showPackagesModal();
                }
            }

            /**
             * Se llama si el usuario confirma guardar con diferencias.
             */
            async function confirmFinalizeWithDifferences() {
                confirmationModal.classList.add('hidden');
                // Mostrar modal de bultos antes de guardar
                showPackagesModal();
            }

            /**
             * Muestra el modal para ingresar cantidad de bultos.
             */
            function showPackagesModal() {
                packagesInput.value = '';
                packagesModal.classList.remove('hidden');
                packagesInput.focus();
            }

            /**
             * Oculta el modal de bultos.
             */
            function hidePackagesModal() {
                packagesModal.classList.add('hidden');
            }

            /**
             * Confirma la cantidad de bultos y procede a guardar.
             */
            async function confirmPackages() {
                const packages = parseInt(packagesInput.value, 10);
                if (isNaN(packages) || packages < 1) {
                    showMessage('Por favor ingrese una cantidad válida de bultos (mínimo 1).', 'error');
                    return;
                }

                packagesQuantity = packages;
                hidePackagesModal();

                // Determinar el estado según si hay diferencias
                const differencesExist = orderItems.some(item => item.qty_scan !== item.qty_req);
                const status = differencesExist ? 'Con Diferencia' : 'Completo';

                const saved = await saveAuditData(status);
                if (saved) {
                    const message = differencesExist
                        ? `¡Auditoría Finalizada con diferencias! ${packages} bulto(s). Guardado.`
                        : `¡Auditoría Finalizada! ${packages} bulto(s). Picking OK y guardado.`;
                    showMessage(message, "success", 5000);
                    resetApp();
                }
            }

            /**
             * Resetea la aplicación a su estado inicial.
             */
            function resetApp() {
                stopScanner();
                orderItems = [];
                customerName = "";
                customerNameEl.textContent = "";
                orderNumberDisplay.textContent = "";
                despatchNumberDisplay.textContent = "";
                itemsTableBody.innerHTML = '';
                orderNumberInput.value = '';
                despatchNumberInput.value = '';

                auditSection.classList.add('hidden');
                loadSection.classList.remove('hidden');
                confirmationModal.classList.add('hidden');
            }

            /**
             * Muestra un mensaje temporal (toast) en pantalla.
             */
            function showMessage(message, type = "info", duration = 3000) {
                messageText.textContent = message;

                messageBox.classList.remove('bg-green-500', 'bg-red-500', 'bg-yellow-500', 'bg-blue-500', 'opacity-0', 'translate-x-10', 'hidden');

                switch (type) {
                    case "success": messageBox.classList.add('bg-green-500'); break;
                    case "error": messageBox.classList.add('bg-red-500'); break;
                    case "warning": messageBox.classList.add('bg-yellow-500'); break;
                    default: messageBox.classList.add('bg-blue-500');
                }

                messageBox.classList.remove('hidden');
                requestAnimationFrame(() => {
                    messageBox.classList.remove('opacity-0', 'translate-x-10');
                });

                setTimeout(() => {
                    messageBox.classList.add('opacity-0', 'translate-x-10');
                    setTimeout(() => {
                        messageBox.classList.add('hidden');
                    }, 300); // Esperar que termine la transición de salida
                }, duration);
            }

        </script>
    </main>

    <script>
        // --- CÓDIGO PARA EL MENÚ DESPLEGABLE ---
        const menuToggle = document.getElementById('menuToggle');
        const dropdownMenu = document.getElementById('dropdownMenu');
        const menuOverlay = document.getElementById('menuOverlay');

        function toggleMenu() {
            dropdownMenu.classList.toggle('open');
            menuOverlay.classList.toggle('active');
        }

        if (menuToggle) {
            menuToggle.addEventListener('click', toggleMenu);
        }

        if (menuOverlay) {
            menuOverlay.addEventListener('click', toggleMenu);
        }

        if (dropdownMenu) {
            const menuLinks = dropdownMenu.querySelectorAll('a, button');
            menuLinks.forEach(link => {
                link.addEventListener('click', () => {
                    if (dropdownMenu.classList.contains('open')) {
                        toggleMenu();
                    }
                });
            });
        }
        // --- FIN DEL CÓDIGO DEL MENÚ ---
    </script>

</body>

<script>
    // Detección de orientación: mostrar overlay si está en landscape
    (function () {
        const overlay = document.getElementById('rotate-overlay');
        if (!overlay) return;

        function updateOverlay() {
            // Mostrar overlay sólo en pantallas pequeñas / táctiles y en landscape
            const isSmallScreen = window.matchMedia('(max-width: 1024px)').matches || window.matchMedia('(pointer: coarse)').matches;
            const isLandscape = window.matchMedia('(orientation: landscape)').matches || window.innerWidth > window.innerHeight;
            if (isSmallScreen && isLandscape) overlay.classList.remove('hidden'); else overlay.classList.add('hidden');
        }

        window.addEventListener('orientationchange', updateOverlay);
        window.addEventListener('resize', updateOverlay);
        updateOverlay();
    })();
</script>

</html>