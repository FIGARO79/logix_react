<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logix - Auditoría de Picking</title>
    <link rel="icon" type="image/svg+xml"
        href="{{ secure_url_for(request, 'static', path='images/gear-wide-connected.svg') }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/css/fallback.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.min.js" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
        /* ===== SAP Business One Inspired Styles ===== */
        :root {
            --sap-primary: #0070d2;
            --sap-primary-dark: #005fb2;
            --sap-header-bg: #2c3e50;
            --sap-header-text: #ffffff;
            --sap-border: #d0d7de;
            --sap-hover: #f3f6f9;
            --sap-text: #32383e;
            --sap-yellow: #fbbf24;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: var(--sap-text);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            margin: 0;
        }

        /* Header superior */
        /* Header superior - SAP Fiori Shell Bar */
        .top-header {
            background-color: var(--sap-header-bg);
            color: white;
            padding: 0 1rem;
            height: 44px;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 0.125rem 0.5rem 0 rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        .menu-toggle {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.25rem;
            transition: background-color 0.1s ease;
        }

        .menu-toggle:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .menu-toggle:active {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .menu-toggle svg {
            width: 1.25rem;
            height: 1.25rem;
        }

        .header-title {
            font-size: 1rem;
            font-weight: 400;
            margin: 0;
            color: #fff;
        }

        /* Menú desplegable - SAP Fiori Side Navigation */
        .dropdown-menu {
            position: fixed;
            top: 44px;
            left: 0;
            width: 15rem;
            max-height: calc(100vh - 44px);
            background-color: var(--sap-header-bg);
            box-shadow: 0 0 0.5rem 0 rgba(0, 0, 0, 0.5);
            transform: translateX(-100%);
            transition: transform 0.2s cubic-bezier(0.1, 0.9, 0.2, 1);
            overflow-y: auto;
            z-index: 999;
        }

        .dropdown-menu.open {
            transform: translateX(0);
        }

        .dropdown-menu nav {
            padding: 0.5rem 0;
        }

        .dropdown-menu a,
        .dropdown-menu .logout-btn {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 1rem;
            color: #fff;
            text-decoration: none;
            border-radius: 0;
            margin: 0;
            transition: background-color 0.1s ease;
            font-size: 0.875rem;
            border-left: 0.1875rem solid transparent;
        }

        .dropdown-menu a:hover,
        .dropdown-menu .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.08);
            border-left-color: var(--sap-primary);
        }

        .dropdown-menu a:active,
        .dropdown-menu .logout-btn:active {
            background-color: rgba(255, 255, 255, 0.12);
        }

        .dropdown-menu svg {
            width: 1rem;
            height: 1rem;
            flex-shrink: 0;
        }

        .logout-btn {
            background: none;
            border: none;
            width: 100%;
            cursor: pointer;
            text-align: left;
        }

        .menu-overlay {
            position: fixed;
            top: 44px;
            left: 0;
            width: 100%;
            height: calc(100vh - 44px);
            background-color: rgba(0, 0, 0, 0.6);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
            z-index: 998;
        }

        .menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .main-content {
            flex-grow: 1;
            overflow-y: auto;
        }

        /* Ocultar el 'spinner' de los inputs numéricos */
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type='number'] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        /* Estilo para el lector de QR */
        #qr-reader {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            overflow: hidden;
            background-color: #f7fafc;
        }
    </style>
</head>


<body>
    <!-- Overlay que pide girar el dispositivo a modo vertical -->
    <div id="rotate-overlay"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 text-white p-4">
        <div class="max-w-sm text-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto mb-4" width="64" height="64" viewBox="0 0 24 24"
                fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M12 2v4M12 18v4M4 12H2M22 12h-2M5 5l-1.5-1.5M20 20l1.5 1.5M19 5l1.5-1.5M4 20L2.5 21.5"
                    stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <h2 class="text-xl font-semibold">Gira el dispositivo</h2>
            <p class="mt-2 text-sm">Para una mejor experiencia, usa esta pantalla en modo vertical (portrait).</p>
        </div>
    </div>

    <!-- Header superior con menú -->
    <header class="top-header">
        <button class="menu-toggle" id="menuToggle" aria-label="Abrir menú">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
            </svg>
        </button>
        <h1 class="header-title">Logix - Auditoría de Picking</h1>
    </header>

    <!-- Menú desplegable -->
    <nav class="dropdown-menu" id="dropdownMenu">
        <nav>
            <a href="/">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
                </svg>
                <span>Inicio</span>
            </a>
            <a href="/stock">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                </svg>
                <span>Consultar Stock</span>
            </a>
            <a href="/inbound">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M9 8.25H7.5a2.25 2.25 0 00-2.25 2.25v9a2.25 2.25 0 002.25 2.25h9a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25H15M9 12l3 3m0 0l3-3m-3 3V2.25" />
                </svg>
                <span>Inbound</span>
            </a>
            <a href="/label">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z" />
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 6.75a.75.75 0 110-1.5.75.75 0 010 1.5z" />
                </svg>
                <span>Etiquetado</span>
            </a>
            <a href="/view_logs">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path
                        d="M5 4a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1zm-.5 2.5A.5.5 0 0 1 5 6h6a.5.5 0 0 1 0 1H5a.5.5 0 0 1-.5-.5M5 8a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1zm0 2a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1z" />
                    <path
                        d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2zm10-1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1" />
                </svg>
                <span>Visualizar Logs</span>
            </a>
            <a href="/reconciliation">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path
                        d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8M1.173 8a13 13 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5s3.879 1.168 5.168 2.457A13 13 0 0 1 14.828 8q-.086.13-.195.288c-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5s-3.879-1.168-5.168-2.457A13 13 0 0 1 1.172 8z" />
                    <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5M4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0" />
                </svg>
                <span>Ver conciliación</span>
            </a>
            <a href="/update">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path
                        d="M8 11a.5.5 0 0 0 .5-.5V6.707l1.146 1.147a.5.5 0 0 0 .708-.708l-2-2a.5.5 0 0 0-.708 0l-2 2a.5.5 0 1 0 .708.708L7.5 6.707V10.5a.5.5 0 0 0 .5.5" />
                    <path
                        d="M4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zm0 1h8a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1" />
                </svg>
                <span>Actualizar Ficheros</span>
            </a>
            <a href="/counts">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path
                        d="M14.5 3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5zm-13-1A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2z" />
                    <path
                        d="M7 5.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5m-1.496-.854a.5.5 0 0 1 0 .708l-1.5 1.5a.5.5 0 0 1-.708 0l-.5-.5a.5.5 0 0 1 .708-.708l.146.147 1.146-1.147a.5.5 0 0 1 .708 0M7 9.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5m-1.496-.854a.5.5 0 0 1 0 .708l-1.5 1.5a.5.5 0 0 1-.708 0l-.5-.5a.5.5 0 0 1 .708-.708l.146.147 1.146-1.147a.5.5 0 0 1 .708 0" />
                </svg>
                <span>Conteo de Items</span>
            </a>
            <a href="/view_counts">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path
                        d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v4h10V2a1 1 0 0 0-1-1zm9 6h-3v2h3zm0 3h-3v2h3zm0 3h-3v2h2a1 1 0 0 0 1-1zm-4 2v-2H6v2zm-4 0v-2H3v1a1 1 0 0 0 1 1zm-2-3h2v-2H3zm0-3h2V7H3zm3-2v2h3V7zm3 3H6v2h3z" />
                </svg>
                <span>Validar conteos</span>
            </a>
            <a href="/picking">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path
                        d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 12H4a.5.5 0 0 1-.491-.408L2.01 3.607 1.61 2H.5a.5.5 0 0 1-.5-.5M3.102 4l1.313 7h8.17l1.313-7zM5 12a2 2 0 1 0 0 4 2 2 0 0 0 0-4m7 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4m-7 1a1 1 0 1 1 0 2 1 1 0 0 1 0-2m7 0a1 1 0 1 1 0 2 1 1 0 0 1 0-2" />
                </svg>
                <span>Auditoría de Picking</span>
            </a>
            <a href="/view_picking_audits">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                        d="M10.854 7.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 9.793l2.646-2.647a.5.5 0 0 1 .708 0z" />
                    <path
                        d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z" />
                    <path
                        d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0z" />
                </svg>
                <span>Confirmación Picking</span>
            </a>
            <button class="logout-btn" onclick="window.location.href='/logout'">
                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M7.5 1v7h1V1z" />
                    <path
                        d="M3 8.812a5 5 0 0 1 2.578-4.375l-.485-.874A6 6 0 1 0 11 3.616l-.501.865A5 5 0 1 1 3 8.812" />
                </svg>
                <span>Cerrar Sesión</span>
            </button>
        </nav>
    </nav>

    <!-- Overlay para cerrar el menú -->
    <div class="menu-overlay" id="menuOverlay"></div>

    <!-- Contenido principal -->
    <main class="main-content">
        <div class="container mx-auto max-w-3xl w-full px-2 pb-2 pt-4 md:px-4 md:pb-4">
            <div class="bg-white p-6 md:p-8 rounded-lg shadow-xl border border-gray-200">

                <!-- Sección 1: Carga de Pedido -->
                <section id="load-section" class="mb-6">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Auditoría de Picking</h1>
                    <h2 class="text-xl font-semibold mb-4">1. Cargar Pedido</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="order-number" class="block text-sm font-medium text-gray-700">Order
                                Number</label>
                            <input type="text" id="order-number" inputmode="numeric"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-base sm:text-sm"
                                placeholder="Ej: 0043785">
                        </div>
                        <div>
                            <label for="despatch-number" class="block text-sm font-medium text-gray-700">Despatch
                                Number</label>
                            <input type="text" id="despatch-number" inputmode="numeric"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-base sm:text-sm"
                                placeholder="Ej: 00">
                        </div>
                    </div>

                    <button id="load-order-btn"
                        class="mt-6 w-full bg-blue-600 text-white py-2 px-4 rounded-md font-semibold shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Cargar Pedido
                    </button>
                </section>

                <!-- Sección 2: Auditoría (Oculta por defecto) -->
                <section id="audit-section" class="hidden">
                    <header class="mb-6">
                        <h1 class="text-3xl font-bold text-gray-800">Chequeo de picking</h1>
                    </header>

                    <div class="mb-6 space-y-2">
                        <p class="text-lg">Orden: <span id="order-number-display"
                                class="font-bold text-gray-700"></span>/<span id="despatch-number-display"
                                class="font-bold text-gray-700"></span></p>
                        <p class="text-lg">Cliente: <span id="customer-name" class="font-bold text-gray-700"></span></p>
                    </div>

                    <!-- Escáner y Búsqueda de Items (Diseño de la imagen) -->
                    <div class="mb-6">
                        <label for="itemCode" class="block text-sm font-medium text-gray-700 mb-1">ITEM CODE:</label>
                        <div class="flex items-center gap-2">
                            <input type="text" id="itemCode" name="itemCode"
                                class="flex-grow block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-base sm:text-sm"
                                placeholder="Escanee el código o ingrese el item"
                                oninput="this.value = this.value.toUpperCase()" />

                            <!-- Botón QR -->
                            <button type="button" id="scanItemBtn" title="Escanear código de barras"
                                class="flex-shrink-0 p-2 border border-gray-300 bg-gray-100 text-gray-600 rounded-md shadow-sm hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"
                                    class="bi bi-qr-code-scan" viewBox="0 0 16 16">
                                    <path
                                        d="M0 .5A.5.5 0 0 1 .5 0h3a.5.5 0 0 1 0 1H1v2.5a.5.5 0 0 1-1 0zm12 0a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0V1h-2.5a.5.5 0 0 1-.5-.5M.5 12a.5.5 0 0 1 .5.5V15h2.5a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5v-3a.5.5 0 0 1 .5-.5m15 0a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1 0-1H15v-2.5a.5.5 0 0 1 .5-.5M4 4h1v1H4z" />
                                    <path d="M7 2H2v5h5zM3 3h3v3H3zm2 8H4v1h1z" />
                                    <path d="M7 9H2v5h5zm-4 1h3v3H3zm8-6h1v1h-1z" />
                                    <path
                                        d="M9 2h5v5H9zm1 1v3h3V3zM8 8v2h1v1H8v1h2v-2h1v2h1v-1h2v-1h-3V8zm2 2H9V9h1zm4 2h-1v1h-2v1h3zm-4 2v-1H8v1z" />
                                    <path d="M12 9h2V8h-2z" />
                                </svg>
                            </button>
                            <!-- Botón Buscar -->
                            <button type="button" id="findItemBtn"
                                class="flex-shrink-0 bg-gray-600 text-white py-2 px-5 rounded-md font-semibold shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                Buscar
                            </button>
                        </div>
                    </div>



                    <!-- Lista de Items -->
                    <div>
                        <h3 class="text-xl font-semibold mb-4">Lista de items</h3>
                        <div class="border rounded-md max-h-[400px] md:max-h-[500px] overflow-y-auto">
                            <table class="w-full divide-y divide-gray-200 table-auto">
                                <!-- ***** CORRECCIÓN APLICADA AQUÍ (thead) ***** -->
                                <thead class="bg-gray-50 sticky top-0 z-10">
                                    <tr>
                                        <th scope="col"
                                            class="px-1 py-1 md:px-2 md:py-1 text-left text-xs font-small text-gray-500 uppercase tracking-wider">
                                            Item Code</th>
                                        <th scope="col"
                                            class="px-2 py-1 md:px-2 md:py-1 text-left text-xs font-small text-gray-500 uppercase tracking-wider">
                                            Descripción</th>
                                        <th scope="col"
                                            class="px-2 py-1 md:px-2 md:py-1 text-center text-xs font-small text-gray-500 uppercase tracking-wider">
                                            Req.</th>
                                        <th scope="col"
                                            class="px-2 py-1 md:px-2 md:py-1 text-center text-xs font-small text-gray-500 uppercase tracking-wider">
                                            Scan.</th>
                                        <th scope="col"
                                            class="px-2 py-1 md:px-2 md:py-1 text-center text-xs font-small text-gray-500 uppercase tracking-wider">
                                            Dif.</th>
                                    </tr>
                                </thead>
                                <tbody id="items-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Filas de items se insertarán aquí -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Acciones Finales (Diseño de la imagen) -->
                    <div class="mt-8 flex flex-col md:flex-row gap-4">
                        <button id="finalize-btn"
                            class="flex-1 order-1 bg-green-600 text-white py-3 px-6 rounded-md font-semibold shadow-sm hover:bg-green-700 text-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            Finalizar Auditoría
                        </button>
                        <button id="reset-btn"
                            class="flex-1 order-2 md:order-2 bg-gray-200 text-gray-700 py-3 px-6 rounded-md font-semibold hover:bg-gray-300 text-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                            Cargar Otro Pedido
                        </button>
                    </div>
                </section>
            </div>
        </div>

        <!-- Modal del Escáner -->
        <div id="scanner-modal"
            class="hidden fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-[95%] max-w-lg p-6">
                <h3 class="text-lg font-bold mb-4 text-center">Apunta la cámara al código de barras</h3>
                <div id="qr-reader" class="w-full rounded-md overflow-hidden border"></div>
                <button id="close-scanner-btn"
                    class="mt-4 w-full bg-red-600 text-white py-2 rounded-md hover:bg-red-700">Cancelar</button>
            </div>
        </div>

        <!-- Contenedor de Mensajes (Toast) -->
        <div id="message-box"
            class="fixed top-5 right-5 left-5 md:left-auto md:w-auto z-50 p-4 rounded-md text-white font-semibold shadow-lg transition-all duration-300 opacity-0 translate-x-10 hidden text-center md:text-left">
            <span id="message-text"></span>
        </div>

        <!-- Modal de Confirmación -->
        <div id="confirmation-modal"
            class="hidden fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6">
                <h3 class="text-xl font-bold text-yellow-600 mb-4">Confirmar Finalización</h3>
                <p class="text-gray-700 mb-6">Se detectaron diferencias en el picking (faltantes o sobrantes). ¿Desea
                    guardar y finalizar la auditoría de todos modos?</p>
                <div class="flex justify-end gap-4">
                    <button id="cancel-modal-btn"
                        class="py-2 px-4 bg-gray-200 text-gray-700 rounded-md font-semibold hover:bg-gray-300">Cancelar</button>
                    <button id="confirm-modal-btn"
                        class="py-2 px-4 bg-yellow-500 text-white rounded-md font-semibold hover:bg-yellow-600">Confirmar
                        y
                        Guardar</button>
                </div>
            </div>
        </div>

        <!-- Modal de Cantidad -->
        <div id="quantity-modal"
            class="hidden fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4" id="quantity-modal-item-name"></h3>
                <p class="text-gray-700 mb-4">Ingrese la cantidad alistada:</p>
                <input type="number" id="quantity-input" inputmode="numeric" aria-label="Cantidad alistada"
                    placeholder="0"
                    class="w-full text-center border border-gray-300 rounded-md shadow-sm py-2 text-2xl" />
                <div class="flex justify-end gap-4 mt-6">
                    <button id="cancel-quantity-btn"
                        class="py-2 px-4 bg-gray-200 text-gray-700 rounded-md font-semibold hover:bg-gray-300">Cancelar</button>
                    <button id="confirm-quantity-btn"
                        class="py-2 px-4 bg-blue-600 text-white rounded-md font-semibold hover:bg-blue-700">Confirmar</button>
                </div>
            </div>
        </div>


        <script>
            // --- Variables Globales ---
            let orderItems = []; // Almacenará los items del pedido filtrado
            let customerName = "";
            let html5QrCode;
            let soundBeep, soundBoop;
            let currentItemForQuantity = null;

            // --- Selectores del DOM ---
            const loadSection = document.getElementById('load-section');
            const auditSection = document.getElementById('audit-section');
            const loadOrderBtn = document.getElementById('load-order-btn');
            const orderNumberInput = document.getElementById('order-number');
            const despatchNumberInput = document.getElementById('despatch-number');
            const customerNameEl = document.getElementById('customer-name');
            const orderNumberDisplay = document.getElementById('order-number-display');
            const despatchNumberDisplay = document.getElementById('despatch-number-display');
            const itemsTableBody = document.getElementById('items-table-body');
            const itemCodeInput = document.getElementById('itemCode');
            const scanItemBtn = document.getElementById('scanItemBtn');
            const findItemBtn = document.getElementById('findItemBtn');
            const finalizeBtn = document.getElementById('finalize-btn');
            const resetBtn = document.getElementById('reset-btn');
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            const confirmationModal = document.getElementById('confirmation-modal');
            const cancelModalBtn = document.getElementById('cancel-modal-btn');
            const confirmModalBtn = document.getElementById('confirm-modal-btn');
            const quantityModal = document.getElementById('quantity-modal');
            const quantityModalItemName = document.getElementById('quantity-modal-item-name');
            const quantityInput = document.getElementById('quantity-input');
            const cancelQuantityBtn = document.getElementById('cancel-quantity-btn');
            const confirmQuantityBtn = document.getElementById('confirm-quantity-btn');
            const scannerModal = document.getElementById('scanner-modal');
            const closeScannerBtn = document.getElementById('close-scanner-btn');

            // --- Inicialización ---
            document.addEventListener('DOMContentLoaded', () => {
                // Inicializar el objeto del escáner
                try {
                    html5QrCode = new Html5Qrcode("qr-reader");
                    const Html5QrcodeScanType = {
                        SCAN_TYPE_CAMERA: 0,
                        SCAN_TYPE_FILE: 1
                    }
                } catch (e) {
                    console.error("No se pudo inicializar Html5Qrcode. Asegúrese de que el div 'qr-reader' existe.", e);
                    showMessage("Error al iniciar el componente de escáner.", "error");
                }

                // Inicializar sonidos (sólo si Tone.js se cargó)
                try {
                    soundBeep = new Tone.Synth().toDestination();
                    soundBoop = new Tone.Synth({ oscillator: { type: "square" } }).toDestination();
                } catch (e) {
                    console.warn("Tone.js no se pudo inicializar. Los sonidos estarán desactivados.");
                    soundBeep = { triggerAttackRelease: () => { } }; // Objetos 'dummy'
                    soundBoop = { triggerAttackRelease: () => { } };
                }
            });

            // --- Event Listeners ---
            loadOrderBtn.addEventListener('click', loadOrder); // Cambiado a la función original
            scanItemBtn.addEventListener('click', startScanner);
            closeScannerBtn.addEventListener('click', stopScanner);
            findItemBtn.addEventListener('click', () => processScan(itemCodeInput.value));
            itemCodeInput.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); processScan(itemCodeInput.value); } });
            finalizeBtn.addEventListener('click', finalizeAudit);
            resetBtn.addEventListener('click', resetApp);
            cancelModalBtn.addEventListener('click', () => confirmationModal.classList.add('hidden'));
            confirmModalBtn.addEventListener('click', confirmFinalizeWithDifferences);
            cancelQuantityBtn.addEventListener('click', hideQuantityModal);
            confirmQuantityBtn.addEventListener('click', confirmQuantity);
            quantityInput.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); confirmQuantity(); } });

            // --- Funciones Principales ---

            /**
             * Carga el pedido desde la API (función original).
             */
            async function loadOrder() {
                const orderNum = orderNumberInput.value.trim();
                const despatchNum = despatchNumberInput.value.trim();

                if (!orderNum || !despatchNum) {
                    showMessage("Por favor, ingrese 'Order Number' y 'Despatch Number'.", "error");
                    return;
                }

                try {
                    // Esta es la llamada a la API que tu código original tenía
                    const response = await fetch(`/api/picking/order/${orderNum}/${despatchNum}`);

                    if (!response.ok) {
                        let errorMsg = `Error al cargar el pedido. Código: ${response.status}`;
                        try {
                            const errorData = await response.json();
                            errorMsg = errorData.detail || errorMsg;
                        } catch (e) {
                            // No se pudo parsear el JSON de error, usar mensaje genérico
                        }
                        throw new Error(errorMsg);
                    }

                    const filteredItems = await response.json();

                    if (filteredItems.length === 0) {
                        showMessage("Pedido no encontrado. Verifique los números.", "error");
                        return;
                    }

                    // Procesar los items encontrados
                    orderItems = filteredItems.map(item => ({
                        code: item["Item Code"] ? item["Item Code"].trim() : '',
                        description: item["Item Description"] ? item["Item Description"].trim() : 'Sin descripción',
                        qty_req: parseInt(item["Qty"], 10) || 0,
                        qty_scan: 0
                    }));

                    customerName = filteredItems[0]["Customer Name"] || "N/A";

                    // Actualizar la UI
                    customerNameEl.textContent = customerName;
                    orderNumberDisplay.textContent = orderNum;
                    despatchNumberDisplay.textContent = despatchNum;
                    updateTable();
                    loadSection.classList.add('hidden');
                    auditSection.classList.remove('hidden');
                    showMessage(`Pedido ${orderNum}/${despatchNum} cargado. Listo para escanear.`, "success");
                    itemCodeInput.focus(); // Poner foco en el input de item

                } catch (e) {
                    showMessage(e.message, "error");
                    console.error(e);
                }
            }


            /**
             * Actualiza la tabla de items con los datos actuales de 'orderItems'.
             */
            function updateTable() {
                itemsTableBody.innerHTML = '';
                let allComplete = true;

                if (orderItems.length === 0) return;

                orderItems.forEach((item, index) => {
                    const diff = item.qty_scan - item.qty_req;
                    let rowClass = 'bg-white';
                    let diffClass = 'text-gray-700';

                    if (diff === 0 && item.qty_scan > 0 && item.qty_scan === item.qty_req) {
                        rowClass = 'bg-green-50'; // Completo
                        diffClass = 'text-green-700 font-bold';
                    } else if (diff < 0 && item.qty_scan > 0) {
                        rowClass = 'bg-yellow-50'; // Parcial
                        diffClass = 'text-yellow-700 font-bold';
                    } else if (diff > 0) {
                        rowClass = 'bg-red-50'; // Sobrante
                        diffClass = 'text-red-700 font-bold';
                    } else if (diff < 0) {
                        diffClass = 'text-red-700 font-bold'; // Faltante (aún no escaneado)
                    }

                    if (diff !== 0) {
                        allComplete = false;
                    }

                    const row = document.createElement('tr');
                    row.className = `${rowClass} transition-colors duration-200`;

                    // ***** CORRECCIÓN APLICADA AQUÍ (tbody) *****
                    row.innerHTML = `
                        <td class="px-2 py-2 md:px-4 md:py-3 text-xs md:text-sm font-medium text-gray-900">${item.code}</td>
                        <td class="px-2 py-2 md:px-4 md:py-3 text-xs md:text-sm text-gray-600">${item.description}</td>
                        <td class="px-2 py-2 md:px-4 md:py-3 whitespace-nowrap text-xs md:text-sm font-bold text-blue-700 text-center">${item.qty_req}</td>
                        <td class="px-2 py-2 md:px-4 md:py-3 whitespace-nowrap text-xs md:text-sm font-bold text-center">
                            <input type="number" value="${item.qty_scan}" min="0" class="w-12 text-center text-base md:text-sm border border-gray-300 rounded-md shadow-sm py-1" data-index="${index}">
                        </td>
                        <td class="px-2 py-2 md:px-4 md:py-3 whitespace-nowrap text-xs md:text-sm font-semibold ${diffClass} text-center">${diff}</td>
                    `;
                    itemsTableBody.appendChild(row);
                });

                // Añadir event listeners a los inputs numéricos de la tabla
                itemsTableBody.querySelectorAll('input[type="number"]').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const index = e.target.dataset.index;
                        let newQty = parseInt(e.target.value, 10);

                        if (isNaN(newQty) || newQty < 0) {
                            newQty = 0; // Resetear a 0 si es inválido
                        }

                        orderItems[index].qty_scan = newQty;
                        updateTable(); // Re-dibujar la tabla para reflejar el cambio
                    });
                });

                // Si todo está completo, mostrar mensaje
                if (allComplete && orderItems.length > 0) {
                    showMessage("¡Picking Completo! Todos los items verificados.", "success");
                }
            }

            /**
             * Inicia la cámara para escanear.
             */
            function startScanner() {
                scannerModal.classList.remove('hidden');
                if (!html5QrCode) {
                    html5QrCode = new Html5Qrcode("qr-reader");
                }

                const config = {
                    fps: 10,
                    qrbox: (viewfinderWidth, viewfinderHeight) => {
                        const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
                        const qrboxSize = Math.floor(minEdge * 0.8); // 80% del borde más pequeño
                        return { width: qrboxSize, height: qrboxSize };
                    },
                    rememberLastUsedCamera: true,
                    supportedScanTypes: [
                        Html5QrcodeScanType.SCAN_TYPE_CAMERA
                    ]
                };

                html5QrCode.start(
                    { facingMode: "environment" }, // Pedir cámara trasera
                    config,
                    (decodedText, decodedResult) => {
                        stopScanner();
                        processScan(decodedText);
                    }, // onScanSuccess
                    (error) => { /* onScanFailure (opcional) */ }
                ).then(() => {
                    showMessage("Cámara iniciada. Apunte al código.", "info");
                }).catch(err => {
                    showMessage("Error al iniciar la cámara. Verifique permisos.", "error");
                    console.error(err);
                    stopScanner();
                });
            }

            /**
             * Detiene el escáner de la cámara.
             */
            function stopScanner() {
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop()
                        .then(() => {
                            showMessage("Escáner detenido.", "info");
                        })
                        .catch(err => {
                            console.error("Error al detener el escáner:", err);
                        });
                }
                scannerModal.classList.add('hidden');
            }

            /**
             * Procesa un código escaneado (de cámara o manual).
             */
            function processScan(scannedCode) {
                if (!scannedCode || scannedCode.trim() === '') return;

                scannedCode = scannedCode.trim().toUpperCase(); // Asegurarse de que esté en mayúsculas
                const item = orderItems.find(i => i.code === scannedCode);

                if (item) {
                    showQuantityModal(item);
                    soundBeep.triggerAttackRelease("C5", "0.1"); // Sonido agudo OK
                } else {
                    soundBoop.triggerAttackRelease("C3", "0.2"); // Sonido grave ERROR
                    showMessage(`ERROR: Item incorrecto (${scannedCode})`, "error");
                    itemCodeInput.value = ''; // Limpiar input manual
                    itemCodeInput.focus(); // Devolver el foco al input
                }
            }

            function showQuantityModal(item) {
                currentItemForQuantity = item;
                quantityModalItemName.textContent = `${item.code} - ${item.description}`;
                quantityInput.value = ''; // Clear previous value
                quantityModal.classList.remove('hidden');
                quantityInput.focus();
            }

            function hideQuantityModal() {
                quantityModal.classList.add('hidden');
                currentItemForQuantity = null;
                itemCodeInput.value = ''; // Limpiar input manual
                itemCodeInput.focus(); // Devolver el foco al input
            }

            function confirmQuantity() {
                if (!currentItemForQuantity) return;

                const quantity = parseInt(quantityInput.value, 10);
                if (!isNaN(quantity) && quantity >= 0) {
                    currentItemForQuantity.qty_scan = quantity;
                    showMessage(`OK: ${currentItemForQuantity.description} - Cantidad: ${quantity}`, "success");
                    updateTable();
                    // Highlight row
                    const row = itemsTableBody.querySelector(`input[data-index="${orderItems.indexOf(currentItemForQuantity)}"]`);
                    if (row) {
                        row.closest('tr').classList.add('bg-blue-100');
                        setTimeout(() => {
                            const currentRow = itemsTableBody.querySelector(`input[data-index="${orderItems.indexOf(currentItemForQuantity)}"]`);
                            if (currentRow) {
                                currentRow.closest('tr').classList.remove('bg-blue-100');
                            }
                        }, 1500);
                    }
                } else {
                    showMessage('Por favor ingrese una cantidad válida.', 'error');
                }
                hideQuantityModal();
            }

            async function saveAuditData(status) {
                const auditData = {
                    order_number: orderNumberDisplay.textContent,
                    despatch_number: despatchNumberDisplay.textContent,
                    customer_name: customerName,
                    status: status,
                    items: orderItems
                };

                try {
                    const response = await fetch('/api/save_picking_audit', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(auditData),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Error al guardar la auditoría.');
                    }

                    const result = await response.json();
                    console.log('Auditoría guardada:', result);
                    return true;

                } catch (error) {
                    console.error('Error al guardar la auditoría:', error);
                    showMessage(error.message, 'error');
                    return false;
                }
            }

            /**
             * Finaliza la auditoría. Comprueba diferencias.
             */
            async function finalizeAudit() {
                // Asegurarse de que se haya cargado un pedido
                if (orderItems.length === 0) {
                    showMessage("No hay ningún pedido cargado para finalizar.", "error");
                    return;
                }

                const differencesExist = orderItems.some(item => item.qty_scan !== item.qty_req);

                if (differencesExist) {
                    // Hay diferencias, mostrar modal de confirmación
                    confirmationModal.classList.remove('hidden');
                } else {
                    // Todo OK
                    const saved = await saveAuditData('Completo');
                    if (saved) {
                        showMessage("¡Auditoría Finalizada! Picking OK y guardado.", "success", 5000);
                        resetApp();
                    }
                }
            }

            /**
             * Se llama si el usuario confirma guardar con diferencias.
             */
            async function confirmFinalizeWithDifferences() {
                confirmationModal.classList.add('hidden');
                const saved = await saveAuditData('Con Diferencia');
                if (saved) {
                    showMessage("Auditoría finalizada y guardada con diferencias.", "warning", 5000);
                    resetApp();
                }
            }

            /**
             * Resetea la aplicación a su estado inicial.
             */
            function resetApp() {
                stopScanner();
                orderItems = [];
                customerName = "";
                customerNameEl.textContent = "";
                orderNumberDisplay.textContent = "";
                despatchNumberDisplay.textContent = "";
                itemsTableBody.innerHTML = '';
                orderNumberInput.value = '';
                despatchNumberInput.value = '';

                auditSection.classList.add('hidden');
                loadSection.classList.remove('hidden');
                confirmationModal.classList.add('hidden');
            }

            /**
             * Muestra un mensaje temporal (toast) en pantalla.
             */
            function showMessage(message, type = "info", duration = 3000) {
                messageText.textContent = message;

                messageBox.classList.remove('bg-green-500', 'bg-red-500', 'bg-yellow-500', 'bg-blue-500', 'opacity-0', 'translate-x-10', 'hidden');

                switch (type) {
                    case "success": messageBox.classList.add('bg-green-500'); break;
                    case "error": messageBox.classList.add('bg-red-500'); break;
                    case "warning": messageBox.classList.add('bg-yellow-500'); break;
                    default: messageBox.classList.add('bg-blue-500');
                }

                messageBox.classList.remove('hidden');
                requestAnimationFrame(() => {
                    messageBox.classList.remove('opacity-0', 'translate-x-10');
                });

                setTimeout(() => {
                    messageBox.classList.add('opacity-0', 'translate-x-10');
                    setTimeout(() => {
                        messageBox.classList.add('hidden');
                    }, 300); // Esperar que termine la transición de salida
                }, duration);
            }

        </script>
    </main>

    <script>
        // --- CÓDIGO PARA EL MENÚ DESPLEGABLE ---
        const menuToggle = document.getElementById('menuToggle');
        const dropdownMenu = document.getElementById('dropdownMenu');
        const menuOverlay = document.getElementById('menuOverlay');

        function toggleMenu() {
            dropdownMenu.classList.toggle('open');
            menuOverlay.classList.toggle('active');
        }

        if (menuToggle) {
            menuToggle.addEventListener('click', toggleMenu);
        }

        if (menuOverlay) {
            menuOverlay.addEventListener('click', toggleMenu);
        }

        if (dropdownMenu) {
            const menuLinks = dropdownMenu.querySelectorAll('a, button');
            menuLinks.forEach(link => {
                link.addEventListener('click', () => {
                    if (dropdownMenu.classList.contains('open')) {
                        toggleMenu();
                    }
                });
            });
        }
        // --- FIN DEL CÓDIGO DEL MENÚ ---
    </script>

</body>

<script>
    // Detección de orientación: mostrar overlay si está en landscape
    (function () {
        const overlay = document.getElementById('rotate-overlay');
        if (!overlay) return;

        function updateOverlay() {
            // Mostrar overlay sólo en pantallas pequeñas / táctiles y en landscape
            const isSmallScreen = window.matchMedia('(max-width: 1024px)').matches || window.matchMedia('(pointer: coarse)').matches;
            const isLandscape = window.matchMedia('(orientation: landscape)').matches || window.innerWidth > window.innerHeight;
            if (isSmallScreen && isLandscape) overlay.classList.remove('hidden'); else overlay.classList.add('hidden');
        }

        window.addEventListener('orientationchange', updateOverlay);
        window.addEventListener('resize', updateOverlay);
        updateOverlay();
    })();
</script>

</html>