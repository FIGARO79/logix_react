<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logix - Ejecución de Conteo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        :root {
            --sap-primary: #0070d2;
            --sap-header-bg: #2c3e50;
            --sap-text: #32383e;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: var(--sap-text);
        }

        .top-header {
            background-color: var(--sap-header-bg);
            color: white;
            padding: 0 1rem;
            height: 44px;
            display: flex;
            align-items: center;
            gap: 1rem;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-title {
            font-size: 1rem;
            font-weight: 400;
        }

        .excel-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .excel-table th,
        .excel-table td {
            border: 1px solid #d0d7de;
            text-align: left;
            vertical-align: middle;
        }

        .excel-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            padding: 6px 8px;
            font-size: 11px;
            text-transform: uppercase;
        }

        .excel-table td {
            padding: 2px 4px;
            font-size: 13px;
        }

        .back-link {
            text-decoration: none;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-link:hover {
            color: white;
        }
    </style>
</head>

<body>

    <header class="top-header shadow-sm">
        <a href="/planner" class="back-link">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
            </svg>
        </a>
        <h1 class="header-title ml-2 font-semibold">Ejecución de Conteo</h1>
    </header>

    <main class="max-w-7xl mx-auto p-2 pb-24 md:p-6">

        <div class="bg-white p-3 md:p-6 rounded-lg shadow-sm border border-gray-200 mb-4">
            <div class="flex flex-col md:flex-row gap-3 items-stretch md:items-end">
                <div class="w-full md:w-auto">
                    <label class="block text-xs font-bold text-gray-700 mb-1">Fecha de Ejecución</label>
                    <input type="date" id="execDate"
                        class="border border-gray-300 rounded px-2 py-2 text-sm focus:border-blue-500 outline-none w-full md:w-48 bg-gray-50">
                </div>
                <button type="button" id="loadDailyItemsBtn"
                    class="bg-blue-700 text-white px-4 py-2 rounded text-sm hover:bg-blue-800 transition-colors font-medium w-full md:w-auto shadow-sm active:scale-95 transform transition-transform">
                    Cargar Items
                </button>
                <button type="button" id="scanBtn"
                    class="bg-gray-700 text-white px-4 py-2 rounded text-sm hover:bg-gray-800 transition-colors font-medium w-full md:w-auto shadow-sm active:scale-95 transform transition-transform flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        viewBox="0 0 16 16">
                        <path
                            d="M0 .5A.5.5 0 0 1 .5 0h3a.5.5 0 0 1 0 1H1v2.5a.5.5 0 0 1-1 0zm12 0a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0V1h-2.5a.5.5 0 0 1-.5-.5M.5 12a.5.5 0 0 1 .5.5V15h2.5a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5v-3a.5.5 0 0 1 .5-.5m15 0a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1 0-1H15v-2.5a.5.5 0 0 1 .5-.5M4 4h1v1H4z" />
                        <path d="M7 2H2v5h5zM3 3h3v3H3zm2 8H4v1h1z" />
                        <path d="M7 9H2v5h5zm-4 1h3v3H3zm8-6h1v1h-1z" />
                        <path
                            d="M9 2h5v5H9zm1 1v3h3V3zM8 8v2h1v1H8v1h2v-2h1v2h1v-1h2v-1h-3V8zm2 2H9V9h1zm4 2h-1v1h-2v1h3zm-4 2v-1H8v1z" />
                        <path d="M12 9h2V8h-2z" />
                    </svg>
                    Escanear
                </button>
            </div>
        </div>

        <div id="statusMessage" class="hidden p-3 rounded mb-4 text-sm font-medium shadow-sm"></div>

        <div id="executionPanel" class="hidden">
            <!-- Count Stats -->
            <div class="flex justify-between items-center mb-2 px-1">
                <div class="text-xs text-gray-500 font-medium">
                    Total Items: <span id="totalItemsCount" class="font-bold text-gray-900 text-sm">0</span>
                </div>
            </div>

            <div class="overflow-x-auto rounded-lg border border-gray-200 bg-white shadow-sm">
                <table class="excel-table w-full whitespace-nowrap" id="executionTable">
                    <thead>
                        <tr class="bg-gray-100 text-gray-700 text-xs uppercase tracking-wider">
                            <th class="px-2 py-2 w-16">Ubic.</th>
                            <th class="px-2 py-2 w-20">Item</th>
                            <th class="px-2 py-2">Desc.</th>
                            <th class="px-1 py-1 text-center w-8">Cat</th>
                            <th class="px-2 py-2 text-center w-20">Físico</th>
                            <th class="px-2 py-2 text-center w-12">Dif.</th>
                        </tr>
                    </thead>
                    <tbody id="executionTableBody" class="divide-y divide-gray-100 text-sm">
                        <!-- Rows loaded via JS -->
                    </tbody>
                </table>
            </div>

            <!-- Sticky Mobile Footer for Save Button -->
            <div
                class="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] md:static md:bg-transparent md:border-0 md:shadow-none md:mt-4 md:p-0 z-50">
                <div class="max-w-7xl mx-auto flex justify-end">
                    <button type="button" id="saveExecutionBtn"
                        class="w-full md:w-auto bg-green-600 text-white px-8 py-3 rounded-lg shadow-md hover:bg-green-700 font-bold text-base transition-all transform active:scale-95">
                        Confirmar y Guardar
                    </button>
                </div>
            </div>
        </div>

        <div id="noItemsMsg"
            class="hidden text-gray-500 italic p-8 text-center bg-white rounded-lg mt-4 border border-dashed border-gray-300">
            <p class="text-base font-medium">Sin tareas</p>
            <p class="text-xs mt-1">No hay items programados para hoy.</p>
        </div>

    </main>

    <!-- Scanner Modal -->
    <div id="scanner-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[2000] p-4">
        <div class="bg-white rounded-lg p-4 max-w-lg w-full">
            <h3 class="text-lg font-bold mb-4 text-center">Escanear Artículo</h3>
            <div id="reader" class="w-full rounded-md overflow-hidden border bg-black h-64"></div>
            <div class="flex gap-2 mt-4">
                <button id="close-scanner-btn"
                    class="flex-1 bg-red-600 text-white py-2 rounded-md hover:bg-red-700 font-medium">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const execDateInput = document.getElementById('execDate');
            const loadBtn = document.getElementById('loadDailyItemsBtn');
            const saveBtn = document.getElementById('saveExecutionBtn');
            const panel = document.getElementById('executionPanel');
            const tableBody = document.getElementById('executionTableBody');
            const noItemsMsg = document.getElementById('noItemsMsg');
            const statusMsg = document.getElementById('statusMessage');
            const totalCountSpan = document.getElementById('totalItemsCount');

            // Scanner Elements
            const scanBtn = document.getElementById('scanBtn');
            const scannerModal = document.getElementById('scanner-modal');
            const closeScannerBtn = document.getElementById('close-scanner-btn');
            let html5QrCode = null;

            // Default to today
            execDateInput.value = new Date().toISOString().split('T')[0];

            function showStatus(msg, type) {
                statusMsg.textContent = msg;
                statusMsg.className = `mb-4 p-3 rounded text-sm font-medium border ${type === 'error' ? 'bg-red-50 text-red-700 border-red-200' : 'bg-green-50 text-green-700 border-green-200'}`;
                statusMsg.classList.remove('hidden');
                if (type === 'success') setTimeout(() => statusMsg.classList.add('hidden'), 5000);
            }

            // Load Items
            loadBtn.addEventListener('click', async () => {
                const date = execDateInput.value;
                if (!date) return showStatus("Fecha requerida", "error");

                loadBtn.disabled = true;
                loadBtn.innerHTML = '<span class="animate-pulse">Cargando...</span>';
                statusMsg.classList.add('hidden');

                try {
                    const res = await fetch(`/api/planner/execution/daily_items?date=${date}`);
                    if (res.ok) {
                        const items = await res.json();
                        renderTable(items);
                    } else {
                        showStatus("Error al cargar", "error");
                    }
                } catch (e) {
                    console.error(e);
                    showStatus("Error de conexión", "error");
                } finally {
                    loadBtn.disabled = false;
                    loadBtn.textContent = "Cargar Items";
                }
            });

            function renderTable(items) {
                tableBody.innerHTML = '';
                if (items.length === 0) {
                    panel.classList.add('hidden');
                    noItemsMsg.classList.remove('hidden');
                    return;
                }

                noItemsMsg.classList.add('hidden');
                panel.classList.remove('hidden');
                totalCountSpan.textContent = items.length;

                items.forEach(item => {
                    const row = document.createElement('tr');

                    row.innerHTML = `
                        <td class="font-bold text-blue-700">${item.bin_location || '-'}</td>
                        <td class="font-mono text-xs text-gray-500">${item.item_code}</td>
                        <td class="text-xs text-gray-800 max-w-[150px] truncate" title="${item.description}">${item.description}</td>
                        <td class="text-center font-bold text-gray-400 text-xs">${item.abc_code || '-'}</td>
                        <td class="text-center">
                            <input type="tel" class="physical-input w-full md:w-20 border border-gray-300 rounded px-1 py-1 text-center font-bold text-sm text-gray-900 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all"
                                placeholder="-"
                                data-system="${item.system_qty}" 
                                data-code="${item.item_code}" 
                                data-abc="${item.abc_code}">
                        </td>
                        <td class="difference-cell text-center font-bold text-gray-300 text-xs">-</td>
                    `;
                    tableBody.appendChild(row);
                });

                // Attach listeners
                document.querySelectorAll('.physical-input').forEach(input => {
                    input.addEventListener('input', (e) => {
                        const valStr = e.target.value;
                        const val = valStr === '' ? '' : parseInt(valStr);
                        const sys = parseInt(e.target.dataset.system);
                        const diffCell = e.target.closest('tr').querySelector('.difference-cell');

                        if (val === '' || isNaN(val)) {
                            diffCell.textContent = "-";
                            diffCell.className = "difference-cell text-center font-bold text-gray-300 text-xs";
                            e.target.classList.remove('bg-green-50', 'bg-red-50', 'text-green-700', 'text-red-700');
                        } else {
                            const diff = val - sys;
                            diffCell.textContent = diff > 0 ? `+${diff}` : diff;

                            if (diff === 0) {
                                diffCell.className = "difference-cell text-center font-bold text-green-600 text-xs";
                                e.target.classList.add('bg-green-50', 'text-green-700');
                                e.target.classList.remove('bg-red-50', 'text-red-700');
                            } else {
                                diffCell.className = "difference-cell text-center font-bold text-red-600 text-xs";
                                e.target.classList.add('bg-red-50', 'text-red-700');
                                e.target.classList.remove('bg-green-50', 'text-green-700');
                            }
                        }
                    });

                    // Enter key nav
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const inputs = Array.from(document.querySelectorAll('.physical-input'));
                            const idx = inputs.indexOf(e.target);
                            if (idx >= 0 && idx < inputs.length - 1) {
                                inputs[idx + 1].focus();
                            } else {
                                // Close keyboard on last item
                                e.target.blur();
                            }
                        }
                    });
                });
            }

            // Save Logic
            saveBtn.addEventListener('click', async () => {
                const inputs = document.querySelectorAll('.physical-input');
                const itemsToSave = [];
                let hasEmpty = false;

                inputs.forEach(input => {
                    const val = input.value;
                    if (val === '') {
                        hasEmpty = true;
                        input.classList.add('border-red-500', 'ring-1', 'ring-red-200');
                    } else {
                        input.classList.remove('border-red-500', 'ring-1', 'ring-red-200');
                        itemsToSave.push({
                            item_code: input.dataset.code,
                            description: input.closest('tr').children[2].title || input.closest('tr').children[2].textContent,
                            bin_location: input.closest('tr').children[0].textContent,
                            system_qty: parseInt(input.dataset.system),
                            physical_qty: parseInt(val),
                            abc_code: input.dataset.abc === 'undefined' ? null : input.dataset.abc
                        });
                    }
                });

                if (itemsToSave.length === 0) return showStatus("Ingrese al menos un conteo", "error");

                let confirmMsg = `¿Guardar ${itemsToSave.length} conteos?`;
                if (hasEmpty) confirmMsg = `Hay ${inputs.length - itemsToSave.length} pendientes.\n\n` + confirmMsg;

                if (!confirm(confirmMsg)) return;

                saveBtn.disabled = true;
                saveBtn.textContent = "Guardando...";

                try {
                    const res = await fetch('/api/planner/execution/save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            date: execDateInput.value,
                            items: itemsToSave
                        })
                    });

                    if (res.ok) {
                        showStatus("¡Guardado!", "success");
                        setTimeout(() => window.location.href = '/planner', 1000);
                    } else {
                        const err = await res.json();
                        showStatus(err.detail || "Error", "error");
                        saveBtn.disabled = false;
                        saveBtn.textContent = "Confirmar y Guardar";
                    }
                } catch (e) {
                    console.error(e);
                    showStatus("Error de conexión", "error");
                    saveBtn.disabled = false;
                    saveBtn.textContent = "Confirmar y Guardar";
                }
            });

            // --- Scanner Logic ---
            function onScanSuccess(decodedText, decodedResult) {
                // Stop scanning
                if (html5QrCode) {
                    html5QrCode.stop().then(() => {
                        scannerModal.classList.add('hidden');
                        document.body.style.overflow = '';
                        html5QrCode = null;
                    }).catch(err => console.error(err));
                }

                const searchCode = decodedText.trim().toUpperCase();

                // Find input with this code
                const inputs = Array.from(document.querySelectorAll('.physical-input'));
                const targetInput = inputs.find(input => input.dataset.code === searchCode);

                if (targetInput) {
                    showStatus(`Item ${searchCode} encontrado`, 'success');

                    // Highlight and scroll
                    const row = targetInput.closest('tr');

                    // Remove previous highlights
                    document.querySelectorAll('tr.bg-yellow-100').forEach(r => r.classList.remove('bg-yellow-100'));

                    row.classList.add('bg-yellow-100');
                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    // Focus and select
                    setTimeout(() => {
                        targetInput.focus();
                        targetInput.select();
                    }, 500);

                } else {
                    showStatus(`Item ${searchCode} no encontrado en la lista de hoy`, 'error');
                }
            }

            scanBtn.addEventListener('click', () => {
                scannerModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // Prevent background scrolling

                html5QrCode = new Html5Qrcode("reader");
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };

                // Prefer back camera
                html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
                    .catch(err => {
                        console.error("Error starting scanner", err);
                        showStatus("No se pudo iniciar la cámara: " + err, "error");
                        scannerModal.classList.add('hidden');
                        document.body.style.overflow = '';
                    });
            });

            closeScannerBtn.addEventListener('click', () => {
                if (html5QrCode) {
                    html5QrCode.stop().then(() => {
                        html5QrCode = null;
                        scannerModal.classList.add('hidden');
                        document.body.style.overflow = '';
                    }).catch(err => console.error(err));
                } else {
                    scannerModal.classList.add('hidden');
                    document.body.style.overflow = '';
                }
            });
        });
    </script>
</body>

</html>