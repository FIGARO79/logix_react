const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/qrcode-vendor-ClTz9A3x.js","assets/react-vendor-BFe66WFD.js"])))=>i.map(i=>d[i]);
import{_ as e,j as s}from"./index-wQJwC0jU.js";import{e as t,r as a}from"./react-vendor-BFe66WFD.js";import{y as n,L as r}from"./ui-vendor-i8Pm06Jj.js";/* empty css                      */const c=()=>{const{setTitle:c}=t();a.useEffect(()=>{c("Logix - Conteo de Inventario")},[c]);const[i,o]=a.useState(null),[l,d]=a.useState(!0),[h,m]=a.useState(""),[x,p]=a.useState(""),[u,b]=a.useState(""),[v,f]=a.useState(""),[j,y]=a.useState(""),[g,N]=a.useState(!1),[w,C]=a.useState([]),[z,S]=a.useState([]),[H,E]=a.useState(!1),[_,k]=a.useState(null),[M,I]=a.useState(!1),V=a.useRef(null);a.useEffect(()=>{U()},[]),a.useEffect(()=>{i&&A()},[i,h]);const U=async()=>{d(!0);try{const e=await fetch("/api/sessions/active");if(e.ok){const s=await e.json();o(s)}else o(null)}catch(e){o(null)}finally{d(!1)}},q=async()=>{try{const e=await fetch("/api/sessions/start",{method:"POST"});if(e.ok){const s=await e.json();o(s),n.success("Sesión iniciada")}else n.error("Error iniciando sesión")}catch(e){n.error("Error de conexión")}},A=async()=>{if(i){try{const e=await fetch(`/api/sessions/${i.id}/locations`);e.ok&&S(await e.json())}catch(e){}if(h)try{const e=await fetch(`/api/sessions/${i.id}/counts/${encodeURIComponent(h)}`);e.ok&&C(await e.json())}catch(e){}else C([])}},T=async e=>{var s;if(e){N(!0),b(""),f("");try{const t=await fetch(`/api/get_item_for_counting/${encodeURIComponent(e)}`);if(t.ok){const e=await t.json();p(e.item_code),b(e.description),f(e.bin_location||"N/A"),null==(s=document.getElementById("counted_qty"))||s.focus()}else n.error("Item no encontrado o no requerido en esta etapa")}catch(t){n.error("Error buscando item")}finally{N(!1)}}},$=()=>{p(""),b(""),f(""),y("")},B=e=>{k(e),E(!0)};return a.useEffect(()=>(H&&!V.current&&e(async()=>{const{Html5Qrcode:e}=await import("./qrcode-vendor-ClTz9A3x.js").then(e=>e.i);return{Html5Qrcode:e}},__vite__mapDeps([0,1])).then(({Html5Qrcode:e})=>{const s=new e("reader");V.current=s,s.start({facingMode:"environment"},{fps:10,qrbox:250},e=>{V.current?V.current.stop().then(()=>{try{V.current.clear()}catch(s){}V.current=null,E(!1),"location"===_?m(e.toUpperCase()):"item"===_&&(p(e.toUpperCase()),T(e.toUpperCase()))}).catch(()=>E(!1)):E(!1)},()=>{}).catch(e=>{E(!1),n.error("Cámara no disponible")})}),()=>{if(V.current)try{V.current.stop().catch(()=>{});try{V.current.clear()}catch(e){}}catch(e){}}),[H]),l?s.jsx("div",{className:"p-8 text-center",children:"Cargando sesión..."}):i?s.jsxs("div",{className:"container-wrapper px-4 py-4",children:[s.jsx(r,{position:"top-right",autoClose:2e3}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[s.jsxs("div",{className:"md:col-span-2 bg-white p-6 rounded-lg shadow border border-gray-200",children:[s.jsxs("div",{className:"flex justify-between items-center mb-6 border-b pb-2",children:[s.jsxs("div",{children:[s.jsxs("h1",{className:"text-xl font-bold text-gray-800",children:["Sesión #",i.id]}),s.jsxs("p",{className:"text-xs text-gray-500",children:["Usuario: ",i.user_username]})]}),s.jsx("button",{onClick:async()=>{if(i&&confirm("¿Seguro que desea finalizar la sesión?"))try{(await fetch(`/api/sessions/${i.id}/close`,{method:"POST"})).ok?(o(null),$(),n.success("Sesión finalizada")):n.error("Error finalizando sesión")}catch(e){n.error("Error de conexión")}},className:"btn-sap btn-secondary text-xs",children:"Finalizar Sesión"})]}),s.jsxs("form",{onSubmit:async e=>{var s;if(e.preventDefault(),!i||!h||!x||""===j)return void n.warning("Complete todos los campos obligatorios");const t={session_id:i.id,item_code:x,counted_qty:parseInt(j),counted_location:h,description:u,bin_location_system:v};try{const e=await fetch("/api/save_count",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(e.ok)n.success("Conteo guardado"),p(""),b(""),f(""),y(""),A(),null==(s=document.getElementById("itemCode"))||s.focus();else{const s=await e.json();n.error(s.detail||"Error guardando")}}catch(a){n.error("Error de conexión")}},className:"space-y-4",children:[s.jsxs("div",{className:"flex items-end gap-2",children:[s.jsxs("div",{className:"flex-grow",children:[s.jsx("label",{className:"form-label",children:"Ubicación Contada*"}),s.jsx("input",{type:"text",value:h,onChange:e=>m(e.target.value.toUpperCase()),className:"uppercase font-bold text-blue-800",placeholder:"SCAN UBICACIÓN",required:!0})]}),s.jsx("button",{type:"button",onClick:()=>B("location"),className:"btn-sap btn-secondary h-[38px] px-3",children:s.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16",children:[s.jsx("path",{d:"M0 .5A.5.5 0 0 1 .5 0h3a.5.5 0 0 1 0 1H1v2.5a.5.5 0 0 1-1 0zm12 0a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0V1h-2.5a.5.5 0 0 1-.5-.5M.5 12a.5.5 0 0 1 .5.5V15h2.5a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5v-3a.5.5 0 0 1 .5-.5m15 0a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1 0-1H15v-2.5a.5.5 0 0 1 .5-.5M4 4h1v1H4z"}),s.jsx("path",{d:"M7 2H2v5h5zM3 3h3v3H3zm2 8H4v1h1z"}),s.jsx("path",{d:"M7 9H2v5h5zm-4 1h3v3H3zm8-6h1v1h-1z"}),s.jsx("path",{d:"M9 2h5v5H9zm1 1v3h3V3zM8 8v2h1v1H8v1h2v-2h1v2h1v-1h2v-1h-3V8zm2 2H9V9h1zm4 2h-1v1h-2v1h3zm-4 2v-1H8v1z"}),s.jsx("path",{d:"M12 9h2V8h-2z"})]})})]}),s.jsxs("div",{className:"flex items-end gap-2",children:[s.jsxs("div",{className:"flex-grow",children:[s.jsx("label",{className:"form-label",children:"Item Code*"}),s.jsx("input",{id:"itemCode",type:"text",value:x,onChange:e=>p(e.target.value.toUpperCase()),onKeyDown:e=>"Enter"===e.key&&(e.preventDefault(),T(x)),className:"uppercase",placeholder:"SCAN ITEM",required:!0})]}),s.jsx("button",{type:"button",onClick:()=>B("item"),className:"btn-sap btn-secondary h-[38px] px-3",children:s.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16",children:[s.jsx("path",{d:"M0 .5A.5.5 0 0 1 .5 0h3a.5.5 0 0 1 0 1H1v2.5a.5.5 0 0 1-1 0zm12 0a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0V1h-2.5a.5.5 0 0 1-.5-.5M.5 12a.5.5 0 0 1 .5.5V15h2.5a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5v-3a.5.5 0 0 1 .5-.5m15 0a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1 0-1H15v-2.5a.5.5 0 0 1 .5-.5M4 4h1v1H4z"}),s.jsx("path",{d:"M7 2H2v5h5zM3 3h3v3H3zm2 8H4v1h1z"}),s.jsx("path",{d:"M7 9H2v5h5zm-4 1h3v3H3zm8-6h1v1h-1z"}),s.jsx("path",{d:"M9 2h5v5H9zm1 1v3h3V3zM8 8v2h1v1H8v1h2v-2h1v2h1v-1h2v-1h-3V8zm2 2H9V9h1zm4 2h-1v1h-2v1h3zm-4 2v-1H8v1z"}),s.jsx("path",{d:"M12 9h2V8h-2z"})]})}),s.jsx("button",{type:"button",onClick:()=>T(x),className:"btn-sap btn-secondary h-[38px]",children:g?"...":"Buscar"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"form-label",children:"Descripción"}),s.jsx("div",{className:"data-field bg-gray-50",children:u})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"form-label",children:"Ubic. Sistema"}),s.jsx("div",{className:"data-field bg-gray-50",children:v})]}),s.jsxs("div",{children:[s.jsx("label",{className:"form-label",children:"Cantidad Contada*"}),s.jsxs("div",{className:"flex items-center",children:[s.jsx("button",{type:"button",onClick:()=>y(e=>Math.max(0,(parseInt(e)||0)-1)),className:"px-3 py-2 border bg-gray-100",children:"-"}),s.jsx("input",{id:"counted_qty",type:"number",value:j,onChange:e=>y(e.target.value),className:"text-center font-bold text-lg",min:"0",required:!0}),s.jsx("button",{type:"button",onClick:()=>y(e=>(parseInt(e)||0)+1),className:"px-3 py-2 border bg-gray-100",children:"+"})]})]})]}),s.jsxs("div",{className:"flex justify-end gap-2 pt-4 border-t",children:[s.jsx("button",{type:"button",onClick:$,className:"btn-sap btn-secondary",children:"Limpiar"}),s.jsx("button",{type:"submit",className:"btn-sap btn-primary",children:"Guardar Conteo"})]})]})]}),s.jsxs("div",{className:"md:col-span-1 space-y-4",children:[s.jsxs("div",{className:"bg-white p-4 rounded shadow",children:[s.jsxs("h3",{className:"font-bold text-sm text-gray-700 mb-2 border-b uppercase",children:["Items en ",h||"..."]}),s.jsx("div",{className:"max-h-60 overflow-y-auto space-y-1",children:0===w.length?s.jsx("p",{className:"text-xs text-gray-400 text-center py-2",children:"Vacío"}):w.map(e=>s.jsxs("div",{className:"flex justify-between items-center text-sm p-1 hover:bg-gray-50",children:[s.jsx("span",{className:"font-mono",children:e.item_code}),s.jsx("span",{className:"font-bold",children:e.counted_qty}),s.jsx("button",{onClick:()=>(async e=>{if(confirm("¿Eliminar este conteo?"))try{(await fetch(`/api/counts/${e}`,{method:"DELETE"})).ok&&(n.success("Eliminado"),A())}catch(s){n.error("Error al eliminar")}})(e.id),className:"text-red-500 font-bold px-2",children:"×"})]},e.id))})]}),s.jsxs("div",{className:"bg-white p-4 rounded shadow",children:[s.jsx("h3",{className:"font-bold text-sm text-gray-700 mb-2 border-b uppercase",children:"Progreso Sesión"}),s.jsx("div",{className:"max-h-60 overflow-y-auto space-y-1 mb-2",children:z.map(e=>s.jsxs("div",{className:"flex justify-between text-xs p-1",children:[s.jsx("span",{children:e.location_code}),s.jsx("span",{className:"open"===e.status?"text-green-600":"text-red-600 font-bold",children:e.status})]},e.id))}),h&&s.jsxs("button",{onClick:async()=>{if(i&&h&&confirm(`¿Cerrar ubicación ${h}?`))try{(await fetch("/api/locations/close",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:i.id,location_code:h})})).ok?(n.success(`Ubicación ${h} cerrada`),m(""),$(),A()):n.error("Error cerrando ubicación")}catch(e){n.error("Error de conexión")}},className:"btn-sap btn-primary w-full text-xs",children:["Cerrar ",h]})]})]})]}),H&&s.jsx("div",{className:"fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4",children:s.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-lg",children:[s.jsxs("h3",{className:"text-center font-bold text-lg mb-4 text-gray-800",children:["Escanear ","location"===_?"Ubicación":"Item"]}),s.jsx("div",{id:"reader",className:"rounded-lg overflow-hidden mb-4 border-2 border-gray-100"}),s.jsxs("div",{className:"flex gap-3",children:[s.jsxs("button",{onClick:()=>{V.current&&V.current.applyVideoConstraints({advanced:[{torch:!M}]}).then(()=>I(!M)).catch(e=>{n.error("Flash no disponible")})},className:"flex-1 h-12 flex items-center justify-center gap-2 rounded bg-[#34495e] hover:bg-[#2c3e50] text-white font-medium transition-colors "+(M?"ring-2 ring-yellow-400":""),title:M?"Apagar Flash":"Encender Flash",children:[s.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",fill:"currentColor",viewBox:"0 0 16 16",children:s.jsx("path",{d:"M2 6a6 6 0 1 1 10.174 4.31c-.203.196-.359.4-.453.619l-.762 1.769A.5.5 0 0 1 10.5 13a.5.5 0 0 1 0 1 .5.5 0 0 1 0 1l-.224.447a1 1 0 0 1-.894.553H6.618a1 1 0 0 1-.894-.553L5.5 15a.5.5 0 0 1 0-1 .5.5 0 0 1 0-1 .5.5 0 0 1-.46-.302l-.761-1.77a1.964 1.964 0 0 0-.453-.618A5.984 5.984 0 0 1 2 6zm6-5a5 5 0 0 0-3.479 8.592c.263.254.514.564.676.941L5.83 12h4.342l.632-1.467c.162-.377.413-.687.676-.941A5 5 0 0 0 8 1z"})}),"Flash"]}),s.jsx("button",{onClick:()=>{V.current?V.current.stop().then(()=>{try{V.current.clear()}catch(e){}E(!1),V.current=null}).catch(()=>E(!1)):E(!1)},className:"flex-1 h-12 flex items-center justify-center bg-[#d32f2f] hover:bg-[#b71c1c] text-white font-medium rounded transition-colors",children:"Cancelar"})]})]})})]}):s.jsxs("div",{className:"container-wrapper max-w-lg mx-auto px-4 py-8 text-center bg-white rounded shadow mt-8",children:[s.jsx("h2",{className:"text-xl font-bold text-gray-700 mb-4",children:"Gestión de Sesiones"}),s.jsx("p",{className:"mb-6 text-gray-500",children:"Inicie una sesión para comenzar el conteo de inventario."}),s.jsx("button",{onClick:q,className:"btn-sap btn-primary w-full py-3",children:"Iniciar Nueva Sesión"})]})};export{c as default};
