import{j as e}from"./index-CtfDg2Lg.js";import{e as s,r as a}from"./react-vendor-BFe66WFD.js";import{L as t,y as n}from"./ui-vendor-i8Pm06Jj.js";/* empty css                      */import{S as i}from"./ScannerModal-CXFaW436.js";const o=()=>{const{setTitle:o}=s();a.useEffect(()=>{o("Logix - Conteo de Inventario")},[o]);const[r,c]=a.useState(null),[l,d]=a.useState(!0),[h,m]=a.useState(""),[x,p]=a.useState(""),[u,v]=a.useState(""),[b,j]=a.useState(""),[f,y]=a.useState(""),[g,N]=a.useState(!1),[w,C]=a.useState([]),[z,S]=a.useState([]),[H,E]=a.useState(!1),[M,k]=a.useState(null);a.useEffect(()=>{_()},[]),a.useEffect(()=>{r&&V()},[r,h]);const _=async()=>{d(!0);try{const e=await fetch("/api/sessions/active");if(e.ok){const s=await e.json();c(s)}else c(null)}catch(e){c(null)}finally{d(!1)}},I=async()=>{try{const e=await fetch("/api/sessions/start",{method:"POST"});if(e.ok){const s=await e.json();c(s),n.success("Sesión iniciada")}else n.error("Error iniciando sesión")}catch(e){n.error("Error de conexión")}},V=async()=>{if(r){try{const e=await fetch(`/api/sessions/${r.id}/locations`);e.ok&&S(await e.json())}catch(e){}if(h)try{const e=await fetch(`/api/sessions/${r.id}/counts/${encodeURIComponent(h)}`);e.ok&&C(await e.json())}catch(e){}else C([])}},U=async e=>{var s;if(e){N(!0),v(""),j("");try{const a=await fetch(`/api/get_item_for_counting/${encodeURIComponent(e)}`);if(a.ok){const e=await a.json();p(e.item_code),v(e.description),j(e.bin_location||"N/A"),null==(s=document.getElementById("counted_qty"))||s.focus()}else n.error("Item no encontrado o no requerido en esta etapa")}catch(a){n.error("Error buscando item")}finally{N(!1)}}},T=()=>{p(""),v(""),j(""),y("")},q=e=>{k(e),E(!0)};return l?e.jsx("div",{className:"p-8 text-center",children:"Cargando sesión..."}):r?e.jsxs("div",{className:"container-wrapper px-4 py-4",children:[e.jsx(t,{position:"top-right",autoClose:2e3}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"md:col-span-2 bg-white p-6 rounded-lg shadow border border-gray-200",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6 border-b pb-2",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-xl font-bold text-gray-800",children:["Sesión #",r.id]}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Usuario: ",r.user_username]})]}),e.jsx("button",{onClick:async()=>{if(r&&confirm("¿Seguro que desea finalizar la sesión?"))try{(await fetch(`/api/sessions/${r.id}/close`,{method:"POST"})).ok?(c(null),T(),n.success("Sesión finalizada")):n.error("Error finalizando sesión")}catch(e){n.error("Error de conexión")}},className:"btn-sap btn-secondary text-xs",children:"Finalizar Sesión"})]}),e.jsxs("form",{onSubmit:async e=>{var s;if(e.preventDefault(),!r||!h||!x||""===f)return void n.warning("Complete todos los campos obligatorios");const a={session_id:r.id,item_code:x,counted_qty:parseInt(f),counted_location:h,description:u,bin_location_system:b};try{const e=await fetch("/api/save_count",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(e.ok)n.success("Conteo guardado"),p(""),v(""),j(""),y(""),V(),null==(s=document.getElementById("itemCode"))||s.focus();else{const s=await e.json();n.error(s.detail||"Error guardando")}}catch(t){n.error("Error de conexión")}},className:"space-y-4",children:[e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsxs("div",{className:"flex-grow",children:[e.jsx("label",{className:"form-label",children:"Ubicación Contada*"}),e.jsx("input",{type:"text",value:h,onChange:e=>m(e.target.value.toUpperCase()),className:"uppercase font-bold text-blue-800",placeholder:"SCAN UBICACIÓN",required:!0})]}),e.jsx("button",{type:"button",onClick:()=>q("location"),className:"btn-sap btn-secondary h-[38px] px-3",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16",children:[e.jsx("path",{d:"M0 .5A.5.5 0 0 1 .5 0h3a.5.5 0 0 1 0 1H1v2.5a.5.5 0 0 1-1 0zm12 0a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0V1h-2.5a.5.5 0 0 1-.5-.5M.5 12a.5.5 0 0 1 .5.5V15h2.5a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5v-3a.5.5 0 0 1 .5-.5m15 0a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1 0-1H15v-2.5a.5.5 0 0 1 .5-.5M4 4h1v1H4z"}),e.jsx("path",{d:"M7 2H2v5h5zM3 3h3v3H3zm2 8H4v1h1z"}),e.jsx("path",{d:"M7 9H2v5h5zm-4 1h3v3H3zm8-6h1v1h-1z"}),e.jsx("path",{d:"M9 2h5v5H9zm1 1v3h3V3zM8 8v2h1v1H8v1h2v-2h1v2h1v-1h2v-1h-3V8zm2 2H9V9h1zm4 2h-1v1h-2v1h3zm-4 2v-1H8v1z"}),e.jsx("path",{d:"M12 9h2V8h-2z"})]})})]}),e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsxs("div",{className:"flex-grow",children:[e.jsx("label",{className:"form-label",children:"Item Code*"}),e.jsx("input",{id:"itemCode",type:"text",value:x,onChange:e=>p(e.target.value.toUpperCase()),onKeyDown:e=>"Enter"===e.key&&(e.preventDefault(),U(x)),className:"uppercase",placeholder:"SCAN ITEM",required:!0})]}),e.jsx("button",{type:"button",onClick:()=>q("item"),className:"btn-sap btn-secondary h-[38px] px-3",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16",children:[e.jsx("path",{d:"M0 .5A.5.5 0 0 1 .5 0h3a.5.5 0 0 1 0 1H1v2.5a.5.5 0 0 1-1 0zm12 0a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0V1h-2.5a.5.5 0 0 1-.5-.5M.5 12a.5.5 0 0 1 .5.5V15h2.5a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5v-3a.5.5 0 0 1 .5-.5m15 0a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1 0-1H15v-2.5a.5.5 0 0 1 .5-.5M4 4h1v1H4z"}),e.jsx("path",{d:"M7 2H2v5h5zM3 3h3v3H3zm2 8H4v1h1z"}),e.jsx("path",{d:"M7 9H2v5h5zm-4 1h3v3H3zm8-6h1v1h-1z"}),e.jsx("path",{d:"M9 2h5v5H9zm1 1v3h3V3zM8 8v2h1v1H8v1h2v-2h1v2h1v-1h2v-1h-3V8zm2 2H9V9h1zm4 2h-1v1h-2v1h3zm-4 2v-1H8v1z"}),e.jsx("path",{d:"M12 9h2V8h-2z"})]})}),e.jsx("button",{type:"button",onClick:()=>U(x),className:"btn-sap btn-secondary h-[38px]",children:g?"...":"Buscar"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Descripción"}),e.jsx("div",{className:"data-field bg-gray-50",children:u})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Ubic. Sistema"}),e.jsx("div",{className:"data-field bg-gray-50",children:b})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Cantidad Contada*"}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("button",{type:"button",onClick:()=>y(e=>Math.max(0,(parseInt(e)||0)-1)),className:"px-3 py-2 border bg-gray-100",children:"-"}),e.jsx("input",{id:"counted_qty",type:"number",value:f,onChange:e=>y(e.target.value),className:"text-center font-bold text-lg",min:"0",required:!0}),e.jsx("button",{type:"button",onClick:()=>y(e=>(parseInt(e)||0)+1),className:"px-3 py-2 border bg-gray-100",children:"+"})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4 border-t",children:[e.jsx("button",{type:"button",onClick:T,className:"btn-sap btn-secondary",children:"Limpiar"}),e.jsx("button",{type:"submit",className:"btn-sap btn-primary",children:"Guardar Conteo"})]})]})]}),e.jsxs("div",{className:"md:col-span-1 space-y-4",children:[e.jsxs("div",{className:"bg-white p-4 rounded shadow",children:[e.jsxs("h3",{className:"font-bold text-sm text-gray-700 mb-2 border-b uppercase",children:["Items en ",h||"..."]}),e.jsx("div",{className:"max-h-60 overflow-y-auto space-y-1",children:0===w.length?e.jsx("p",{className:"text-xs text-gray-400 text-center py-2",children:"Vacío"}):w.map(s=>e.jsxs("div",{className:"flex justify-between items-center text-sm p-1 hover:bg-gray-50",children:[e.jsx("span",{className:"font-mono",children:s.item_code}),e.jsx("span",{className:"font-bold",children:s.counted_qty}),e.jsx("button",{onClick:()=>(async e=>{if(confirm("¿Eliminar este conteo?"))try{(await fetch(`/api/counts/${e}`,{method:"DELETE"})).ok&&(n.success("Eliminado"),V())}catch(s){n.error("Error al eliminar")}})(s.id),className:"text-red-500 font-bold px-2",children:"×"})]},s.id))})]}),e.jsxs("div",{className:"bg-white p-4 rounded shadow",children:[e.jsx("h3",{className:"font-bold text-sm text-gray-700 mb-2 border-b uppercase",children:"Progreso Sesión"}),e.jsx("div",{className:"max-h-60 overflow-y-auto space-y-1 mb-2",children:z.map(s=>e.jsxs("div",{className:"flex justify-between text-xs p-1",children:[e.jsx("span",{children:s.location_code}),e.jsx("span",{className:"open"===s.status?"text-green-600":"text-red-600 font-bold",children:s.status})]},s.id))}),h&&e.jsxs("button",{onClick:async()=>{if(r&&h&&confirm(`¿Cerrar ubicación ${h}?`))try{(await fetch("/api/locations/close",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:r.id,location_code:h})})).ok?(n.success(`Ubicación ${h} cerrada`),m(""),T(),V()):n.error("Error cerrando ubicación")}catch(e){n.error("Error de conexión")}},className:"btn-sap btn-primary w-full text-xs",children:["Cerrar ",h]})]})]})]}),H&&e.jsx(i,{title:"Escanear "+("location"===M?"Ubicación":"Item"),onScan:e=>{E(!1);const s=e.toUpperCase();"location"===M?m(s):"item"===M&&(p(s),U(s))},onClose:()=>E(!1)})]}):e.jsxs("div",{className:"container-wrapper max-w-lg mx-auto px-4 py-8 text-center bg-white rounded shadow mt-8",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-700 mb-4",children:"Gestión de Sesiones"}),e.jsx("p",{className:"mb-6 text-gray-500",children:"Inicie una sesión para comenzar el conteo de inventario."}),e.jsx("button",{onClick:I,className:"btn-sap btn-primary w-full py-3",children:"Iniciar Nueva Sesión"})]})};export{o as default};
